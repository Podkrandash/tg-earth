<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earth 3D</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            image-rendering: pixelated;
            overscroll-behavior: none;
            position: fixed;
            background: #000000;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
        }
        body * {
            overscroll-behavior: none;
            touch-action: none;
        }
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            touch-action: none;
            z-index: 1;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        #loading-container {
            position: relative;
            width: 100px;
            height: 100px;
        }
        #loading-earth {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 48px;
            height: 48px;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg,
                #1a237e 0%, #1a237e 10%,    /* Темно-синий */
                #283593 10%, #283593 20%,   /* Синий */
                #3949ab 20%, #3949ab 30%,   /* Светло-синий */
                #42a5f5 30%, #42a5f5 40%,   /* Голубой (океаны) */
                #81c784 40%, #81c784 50%,   /* Зеленый (континенты) */
                #42a5f5 50%, #42a5f5 60%,   /* Голубой */
                #3949ab 60%, #3949ab 70%,   /* Светло-синий */
                #283593 70%, #283593 80%,   /* Синий */
                #1a237e 80%, #1a237e 90%,   /* Темно-синий */
                #0d47a1 90%, #0d47a1 100%   /* Глубокий синий */
            );
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(66, 165, 245, 0.5);
            image-rendering: pixelated;
        }
        #loading-moon {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: linear-gradient(45deg,
                #9e9e9e 0%, #9e9e9e 25%,    /* Светло-серый */
                #757575 25%, #757575 50%,   /* Серый */
                #616161 50%, #616161 75%,   /* Темно-серый */
                #424242 75%, #424242 100%   /* Очень темно-серый */
            );
            border-radius: 50%;
            transform-origin: 30px center;
            box-shadow: 0 0 5px rgba(158, 158, 158, 0.5);
            image-rendering: pixelated;
        }
        @keyframes rotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(90deg); }
            50% { transform: translate(-50%, -50%) rotate(180deg); }
            75% { transform: translate(-50%, -50%) rotate(270deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes orbit {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateX(30px); }
            25% { transform: translate(-50%, -50%) rotate(90deg) translateX(30px); }
            50% { transform: translate(-50%, -50%) rotate(180deg) translateX(30px); }
            75% { transform: translate(-50%, -50%) rotate(270deg) translateX(30px); }
            100% { transform: translate(-50%, -50%) rotate(360deg) translateX(30px); }
        }
        @keyframes explosion {
            0% { 
                transform: translate(-50%, -50%);
                clip-path: polygon(50% 0%, 60% 40%, 100% 50%, 60% 60%, 50% 100%, 40% 60%, 0% 50%, 40% 40%);
                opacity: 1;
            }
            50% { 
                transform: translate(-50%, -50%) rotate(45deg) scale(1.5);
                clip-path: polygon(50% 0%, 65% 35%, 100% 50%, 65% 65%, 50% 100%, 35% 65%, 0% 50%, 35% 35%);
                opacity: 0.7;
            }
            100% { 
                transform: translate(-50%, -50%) rotate(90deg) scale(3);
                clip-path: polygon(50% 0%, 70% 30%, 100% 50%, 70% 70%, 50% 100%, 30% 70%, 0% 50%, 30% 30%);
                opacity: 0;
            }
        }
        .explosion-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(45deg,
                #fff 0%, #fff 50%,
                #ccc 50%, #ccc 100%
            );
            border-radius: 2px;
            pointer-events: none;
            image-rendering: pixelated;
        }
        .nav-panel {
            position: fixed;
            bottom: -100px; /* Начальная позиция за пределами экрана */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(18, 18, 23, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 8px;
            display: flex; /* Всегда flex, но скрыт за пределами экрана */
            gap: 16px;
            z-index: 998;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-panel.visible {
            bottom: 20px;
            opacity: 1;
        }
        .nav-button {
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            pointer-events: auto;
        }
        .nav-button i {
            font-size: 24px;
            pointer-events: none;
            transition: transform 0.3s ease;
        }
        .nav-button:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .nav-button:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .nav-button:hover i {
            transform: scale(1.1);
        }
        .nav-button.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .tab-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgb(22, 22, 27);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), border-radius 0.3s ease;
            z-index: 999;
            pointer-events: none;
            will-change: transform, border-radius;
            /* Предотвращаем любые взаимодействия, которые могут привести к сворачиванию */
            overscroll-behavior: none;
            touch-action: none;
        }
        .tab-content.active {
            transform: translateY(90px);
            pointer-events: auto;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            /* Даже в активном состоянии блокируем все взаимодействия, которые могут привести к сворачиванию */
            overscroll-behavior: none;
        }
        .tab-content.dragging {
            transition: none;
        }
        .tab-content.closing {
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1), border-radius 0.3s ease;
        }
        .tab-content-inner {
            width: 100%;
            height: calc(100% - 90px);
            padding: 24px;
            box-sizing: border-box;
            color: rgba(255, 255, 255, 0.9);
            opacity: 0;
            transition: opacity 0.3s ease;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* Разрешаем только вертикальную прокрутку, но предотвращаем сворачивание */
            touch-action: pan-y;
            /* Предотвращаем сворачивание мини-аппа при прокрутке */
            overscroll-behavior: contain;
            overscroll-behavior-y: contain;
            /* Дополнительные свойства для предотвращения сворачивания при прокрутке */
            -ms-scroll-chaining: none;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            
            /* Улучшения для сенсорного экрана */
            cursor: default; 
            pointer-events: auto;
            user-select: none;
            -webkit-user-select: none;
            
            /* Улучшения для скроллинга на всех устройствах */
            padding-bottom: 40px; /* Дополнительный отступ снизу для удобства */
        }
        
        /* Добавляем размытие при прокрутке */
        .tab-content-inner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, rgba(22, 22, 27, 1) 0%, rgba(22, 22, 27, 0) 100%);
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .tab-content-inner.scrolled::before {
            opacity: 1;
        }
        .profile-connecting {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            margin-top: 40px;
        }
        .profile-connecting i {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 16px;
        }
        .profile-connecting h4 {
            font-size: 20px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 8px 0;
        }
        .profile-connecting p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            line-height: 1.5;
        }
        .profile-header {
            position: sticky;
            top: 24px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 40px 0 24px 0;
            padding: 20px;
            background: rgba(18, 18, 23, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            flex-wrap: wrap;
        }
        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-info {
            flex: 1;
            min-width: 0;
        }
        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin: 0 0 4px 0;
            letter-spacing: -0.02em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .profile-bio {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .profile-rating {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            text-align: center;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-left: auto;
        }
        .rating-number {
            font-size: 24px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin: 0;
            line-height: 1;
            letter-spacing: -0.02em;
        }
        .rating-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .rating-list-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 24px;
            margin: 0 -24px;
            position: relative;
            height: calc(100% - 180px);
            touch-action: pan-y;
            pointer-events: auto;
        }
        .rating-list {
            list-style: none;
            margin: 0;
            padding: 0;
            touch-action: pan-y;
            pointer-events: auto;
        }
        .rating-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            touch-action: pan-y;
            pointer-events: auto;
        }
        .rating-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .rating-item.current {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
            position: relative;
        }
        .rating-item.current::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: #fff;
            border-radius: 0 2px 2px 0;
        }
        .rating-position {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            width: 30px;
            text-align: center;
        }
        .rating-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .rating-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .rating-user-info {
            flex-grow: 1;
        }
        .rating-username {
            font-size: 15px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 2px 0;
        }
        .rating-score {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin: 0;
        }
        .tab-content h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 20px;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }
        .close-button {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 12px;
            background: rgba(18, 18, 23, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1002;
            pointer-events: auto;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .connect-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 16px;
            width: 100%;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .connect-button:active {
            transform: scale(0.98);
            background: #0077b5;
        }
        @media (max-width: 480px) {
            .profile-header {
                padding: 16px;
                gap: 12px;
            }
            .profile-avatar {
                width: 48px;
                height: 48px;
            }
            .profile-name {
                font-size: 18px;
            }
            .profile-bio {
                font-size: 13px;
            }
            .profile-rating {
                padding: 6px 12px;
            }
            .rating-number {
                font-size: 20px;
            }
            .rating-label {
                font-size: 10px;
                margin-top: 2px;
            }
        }
        .wallet-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 24px;
        }
        .wallet-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .wallet-header i {
            font-size: 24px;
            color: #0098EA;
        }
        .wallet-balance {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .balance-amount {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
        }
        .balance-currency {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }
        .connect-wallet-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, #0098EA, #0063D1);
            color: #fff;
            border: none;
            border-radius: 16px;
            padding: 16px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 152, 234, 0.2);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .connect-wallet-btn:active {
            transform: scale(0.96) translateY(2px);
            box-shadow: 0 4px 16px rgba(0, 152, 234, 0.15);
        }
        .connect-wallet-btn i {
            font-size: 22px;
        }
        .button-pressed {
            transform: scale(0.96) translateY(2px) !important;
            transition: transform 0.15s ease-in-out !important;
        }
        
        @media (hover: none) {
            .connect-wallet-btn:active {
                transform: scale(0.96) translateY(2px);
            }
        }
        .no-users {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            background: none !important;
            border: none !important;
        }
        
        .no-users-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }
        
        .no-users-message i {
            font-size: 48px;
            opacity: 0.5;
        }
        
        .no-users-message p {
            font-size: 16px;
            margin: 0;
        }
        .task-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }
        .task-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }
        .task-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .task-header i {
            font-size: 24px;
            color: #0098EA;
        }
        .task-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }
        .task-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #0098EA, #0063D1);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .task-button:active {
            transform: scale(0.96);
        }
        .task-button i {
            font-size: 20px;
        }
        .task-button.completed {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: default;
            pointer-events: none;
        }
        .task-button.completed i {
            color: #4CAF50;
        }
        .planet-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }
        .planet-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .pollution-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .pollution-bar-container {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        .pollution-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
        }
        .pollution-status {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        .planet-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .action-grid {
            display: flex;
            gap: 16px;
        }
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .action-button:active {
            transform: scale(0.96);
        }
        .action-button i {
            font-size: 20px;
        }
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.08); }
            100% { transform: translateX(-50%) scale(1); }
        }
        #token-balance {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(18, 18, 23, 0.9), rgba(34, 34, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 10px 18px;
            color: #FFFFFF;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 997;
            display: flex;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(255, 255, 255, 0.1);
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script async src="https://unpkg.com/es-module-shims/dist/es-module-shims.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script>
        // Раннняя инициализация Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            try {
                console.log('Ранняя инициализация Telegram WebApp');
                
                // Инициализируем WebApp и сразу расширяем на весь экран
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setBackgroundColor('#000000');
                
                // Максимально усиленное предотвращение сворачивания мини-аппа
                window.Telegram.WebApp.enableClosingConfirmation();
                window.Telegram.WebApp.isClosingConfirmationEnabled = true;
                
                // Скрываем кнопку "Назад" для предотвращения закрытия
                if (window.Telegram.WebApp.BackButton) {
                    window.Telegram.WebApp.BackButton.hide();
                    window.Telegram.WebApp.BackButton.isVisible = false;
                }
                
                // Отключаем жест свайпа на iOS
                if (window.Telegram.WebApp.platform === 'ios') {
                    window.Telegram.WebApp.disableSwipeBack();
                }
                
                // Интервал для удержания приложения в расширенном состоянии
                // Вызывается каждые 200мс для гарантии полноэкранного режима
                const keepExpanded = setInterval(() => {
                    window.Telegram.WebApp.expand();
                    window.Telegram.WebApp.enableClosingConfirmation();
                    if (window.Telegram.WebApp.BackButton) {
                        window.Telegram.WebApp.BackButton.hide();
                    }
                }, 200);
                
                // Удаляем интервал, если страница закрывается
                window.addEventListener('beforeunload', () => {
                    clearInterval(keepExpanded);
                });
                
                // Глобальные обработчики для предотвращения сворачивания
                document.addEventListener('touchstart', function(e) {
                    // Спецификаторы для мест, где разрешен скролл
                    const isScrollableElement = e.target.closest('.tab-content-inner');
                    
                    // Запоминаем начальную точку касания для скролла
                    if (isScrollableElement) {
                        isScrollableElement.dataset.touchStartY = e.touches[0].clientY;
                    } else {
                        // Предотвращаем все касания вне скроллируемых областей
                        e.preventDefault();
                    }
                    
                    // Принудительно разворачиваем WebApp при каждом касании
                    window.Telegram.WebApp.expand();
                }, { passive: false });
                
                document.addEventListener('touchmove', function(e) {
                    const element = e.target.closest('.tab-content-inner');
                    // Если элемент не скроллируемый или мы в верхней части и пытаемся скроллить вниз
                    if (!element || 
                        (element.scrollTop <= 0 && 
                         e.touches[0].clientY > parseFloat(element.dataset.touchStartY || 0))) {
                        e.preventDefault();
                        // Дополнительно расширяем WebApp для предотвращения сворачивания
                        window.Telegram.WebApp.expand();
                    }
                }, { passive: false });
                
                // Блокируем все жесты масштабирования
                const preventGesture = function(e) { e.preventDefault(); };
                document.addEventListener('gesturestart', preventGesture, { passive: false });
                document.addEventListener('gesturechange', preventGesture, { passive: false });
                document.addEventListener('gestureend', preventGesture, { passive: false });
                
                // Предотвращаем любые события, которые могут вызвать сворачивание
                document.addEventListener('scroll', function() {
                    window.Telegram.WebApp.expand();
                }, { passive: true });
                
                // Устанавливаем стили для тела документа, чтобы предотвратить любые скроллы
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
                document.body.style.overscrollBehavior = 'none';
                
            } catch (error) {
                console.error('Ошибка ранней инициализации Telegram WebApp:', error);
        }
    }
    </script>
</head>
<body>
    <div id="loading-screen">
        <div id="loading-container">
            <div id="loading-earth"></div>
            <div id="loading-moon"></div>
        </div>
    </div>
    <div id="scene-container"></div>
    <div class="nav-panel">
        <div class="nav-button" data-section="profile">
            <i class="material-icons">person</i>
        </div>
        <div class="nav-button" data-section="planet">
            <i class="material-icons">public</i>
        </div>
        <div class="nav-button" data-section="tasks">
            <i class="material-icons">assignment</i>
        </div>
        <div class="nav-button" data-section="wallet">
            <i class="material-icons">account_balance_wallet</i>
        </div>
    </div>
    <div class="tab-content">
        <div class="tab-content-inner">
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM полностью загружен - начинаем инициализацию');
            
            // Устанавливаем глобальный обработчик для предотвращения любых скроллов документа
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.height = '100%';
            document.body.style.overscrollBehavior = 'none';
            
            // Убеждаемся, что Telegram WebApp API доступен
            let telegramWebAppLoaded = !!window.Telegram?.WebApp;
            
            if (telegramWebAppLoaded) {
                console.log('Telegram WebApp API обнаружен');
                
                try {
                    // Инициализация Telegram WebApp
                    window.Telegram.WebApp.ready();
                    window.Telegram.WebApp.expand();
                    console.log('Telegram WebApp инициализирован');
                    
                    // Скрываем главную кнопку и отключаем её
                    if (window.Telegram.WebApp.MainButton) {
                        window.Telegram.WebApp.MainButton.hide();
                    }
                    
                    // Отключаем жест смахивания назад на iOS
                    if (window.Telegram.WebApp.platform === 'ios') {
                        window.Telegram.WebApp.disableSwipeBack();
                    }
                    
                    // Установка цвета фона для WebApp
                    window.Telegram.WebApp.setBackgroundColor('#16161b');
                    
                    // Предотвращаем закрытие с помощью BackButton
                    if (window.Telegram.WebApp.BackButton) {
                    window.Telegram.WebApp.BackButton.hide();
                    }
                    
                    // Предотвращаем сворачивание мини-аппа
                    window.Telegram.WebApp.enableClosingConfirmation();
                    
                    // Агрессивный режим предотвращения сворачивания - вызываем expand и проверки часто
                    // Период 100мс позволяет приложению быстро реагировать на попытки свернуть его
                    const protectFromCollapsing = setInterval(() => {
                        window.Telegram.WebApp.expand();
                        window.Telegram.WebApp.enableClosingConfirmation();
                        if (window.Telegram.WebApp.BackButton) {
                        window.Telegram.WebApp.BackButton.hide();
                        }
                    }, 100);
                    
                    // Дополнительная защита - удваиваем интервал для надежности
                    setTimeout(() => {
                        setInterval(() => {
                            window.Telegram.WebApp.expand();
                        }, 200);
                    }, 50);
                    
                    // Останавливаем интервал при закрытии страницы
                    window.addEventListener('beforeunload', () => {
                        clearInterval(protectFromCollapsing);
                    });
                    
                    // Глобальные обработчики для предотвращения сворачивания мини-аппа
                    document.addEventListener('touchstart', function(e) {
                        // Если мы не внутри tab-content-inner, предотвращаем событие
                        const scrollableElement = e.target.closest('.tab-content-inner');
                        if (!scrollableElement) {
                            e.preventDefault();
                        } else {
                            // Сохраняем начальную позицию Y для касаний в скроллируемой области
                            scrollableElement.dataset.startY = e.touches[0].clientY;
                        }
                        
                        // Расширяем WebApp при каждом касании
                        window.Telegram.WebApp.expand();
                    }, { passive: false });
                    
                    // Блокируем скроллинг для всего документа, кроме контента вкладок
                    document.addEventListener('touchmove', function(e) {
                        // Если это не внутри tab-content-inner или если мы в верхней части и тянем вниз
                        const innerTab = e.target.closest('.tab-content-inner');
                        if (!innerTab || 
                            (innerTab.scrollTop <= 0 && e.touches[0].clientY > parseFloat(innerTab.dataset.startY || 0))) {
                            e.preventDefault();
                            
                            // Расширяем WebApp для большей надежности
                                window.Telegram.WebApp.expand();
                        }
                    }, { passive: false });
                    
                    // Предотвращаем любые жесты масштабирования
                    const preventGesture = function(e) { 
                        e.preventDefault();
                        window.Telegram.WebApp.expand();
                    };
                    document.addEventListener('gesturestart', preventGesture, { passive: false });
                    document.addEventListener('gesturechange', preventGesture, { passive: false });
                    document.addEventListener('gestureend', preventGesture, { passive: false });
                    
                    // Дополнительные обработчики для предотвращения сворачивания
                    document.addEventListener('scroll', function() {
                        window.Telegram.WebApp.expand();
                    }, { passive: true });
                    
                    window.addEventListener('resize', function() {
                        window.Telegram.WebApp.expand();
                    });
                    
                    window.addEventListener('focus', function() {
                        window.Telegram.WebApp.expand();
                    });
                    
                    // Обработчик для любых событий, которые могут вызвать системный UI
                    document.addEventListener('visibilitychange', function() {
                        if (document.visibilityState === 'visible') {
                            window.Telegram.WebApp.expand();
                        }
                    });
                    
            } catch (error) {
                    console.error('Ошибка при инициализации Telegram WebApp:', error);
                    telegramWebAppLoaded = false;
                }
            } else {
                console.log('Telegram WebApp API не обнаружен, работаем как обычный веб-сайт');
            }
            
            // Инициализируем интерфейс одинаково для всех платформ
            const navPanel = document.querySelector('.nav-panel');
            if (navPanel) {
                navPanel.classList.add('visible');
                console.log('Панель навигации отображена');
            }
            
            // Блокируем стандартные жесты на мобильных устройствах для всех платформ
            document.addEventListener('touchmove', function(e) {
                // Разрешаем скроллинг только внутри tab-content-inner
                const innerTab = e.target.closest('.tab-content-inner');
                if (!innerTab || 
                    (innerTab.scrollTop <= 0 && e.touches[0].clientY > (innerTab.dataset.startY || 0))) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Общая инициализация для всех платформ
            console.log('Выполняем общую инициализацию');
            updateTokenBalance();
            setupNavigationButtons();
            setupSceneInteraction();
            
            // Настройка обработчиков для кнопок навигации
            function setupNavigationButtons() {
                console.log('Настройка кнопок навигации');
                const navButtons = document.querySelectorAll('.nav-button');
                console.log(`Найдено ${navButtons.length} кнопок навигации`);
                
                if (!navButtons.length) {
                    console.error('Кнопки навигации не найдены!');
                    return;
                }
                
                navButtons.forEach((button, index) => {
                    // Удаляем существующие обработчики перед добавлением новых
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    const section = newButton.getAttribute('data-section');
                    console.log(`Настройка кнопки ${index}: ${section}`);
                    
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const section = this.getAttribute('data-section');
                        if (!section) {
                            console.error('Секция не указана для кнопки');
                            return;
                        }
                        
                        console.log(`[Navigation] Клик по кнопке ${section}`);
                        handleNavClick(section, this);
                    }, { passive: false });
                    
                    // Добавляем также обработчик touchend для лучшей мобильной поддержки
                    newButton.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const section = this.getAttribute('data-section');
                        if (!section) {
                            console.error('Секция не указана для кнопки (touchend)');
                            return;
                        }
                        
                        console.log(`[Navigation] Touchend на кнопке ${section}`);
                        handleNavClick(section, this);
                    }, { passive: false });
                });
            }
            
            // Настройка обработчиков для сцены
            function setupSceneInteraction() {
                console.log('Настройка взаимодействия со сценой');
                const sceneContainer = document.getElementById('scene-container');
                if (sceneContainer) {
                    sceneContainer.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const navPanel = document.querySelector('.nav-panel');
                        if (navPanel && !navPanel.classList.contains('visible')) {
                            navPanel.classList.add('visible');
                            console.log('Панель навигации показана по клику на сцену');
                        }
                    }, { passive: false });
                } else {
                    console.error('Контейнер сцены не найден!');
                }
                
                // Обработка закрытия вкладки
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.close-button')) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Закрытие вкладки по клику на кнопку закрытия');
                        window.closeTab();
                    }
                }, { passive: false });
            }
        });
        
        // Функция для закрытия вкладки
            window.closeTab = function() {
            console.log('Закрытие вкладки');
                const tabContent = document.querySelector('.tab-content');
                const tabInner = document.querySelector('.tab-content-inner');
                const activeButton = document.querySelector('.nav-button.active');
                
                if (activeButton) {
                    activeButton.classList.remove('active');
                }
                
                tabContent.classList.add('closing');
                tabContent.style.transform = 'translateY(100%)';
                tabContent.style.borderTopLeftRadius = '0';
                tabContent.style.borderTopRightRadius = '0';
                tabInner.style.opacity = '0';
                
                setTimeout(() => {
                    tabContent.classList.remove('active', 'closing');
                    tabContent.style.transform = '';
                    tabContent.style.borderTopLeftRadius = '';
                    tabContent.style.borderTopRightRadius = '';
                }, 300);
            };
    </script>
    <script type="module" src="/js/main.js"></script>
    <script>
    // Функция для обработки навигации
    function handleNavClick(section, clickedButton) {
        console.log(`handleNavClick: открытие вкладки ${section}`);
        
        // Расширяем Telegram WebApp при открытии вкладки
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.enableClosingConfirmation();
            if (window.Telegram.WebApp.BackButton) {
                window.Telegram.WebApp.BackButton.hide();
            }
            
            // Обновляем цвет фона WebApp при открытии вкладки
            window.Telegram.WebApp.setBackgroundColor('#16161b');
        }
        
                const buttons = document.querySelectorAll('.nav-button');
                const tabContent = document.querySelector('.tab-content');
                const tabInner = document.querySelector('.tab-content-inner');
                
        if (!tabContent || !tabInner) {
            console.error('Элементы вкладки не найдены!');
            return;
        }
        
        // Настраиваем параметры CSS для элементов вкладки
        tabContent.style.overscrollBehavior = 'none';
        tabInner.style.overscrollBehavior = 'contain';
        tabInner.style.overscrollBehaviorY = 'contain';
        
        // Отмечаем активную кнопку
                buttons.forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                
                let content = '';
                
                switch(section) {
                    case 'wallet':
                console.log('Загрузка содержимого вкладки "Wallet"');
                        content = `
                            <h3>Wallet</h3>
                            <button class="close-button" type="button">
                                <i class="material-icons">close</i>
                            </button>
                            <div class="wallet-container">
                                <div class="wallet-header">
                                    <i class="material-icons">account_balance_wallet</i>
                                    <span>TON Wallet</span>
                                </div>
                                <div class="wallet-content">
                            <p style="margin: 16px 0; font-size: 16px; text-align: center; color: white;">Подключение кошелька будет доступно ближе к аирдропу.</p>
                            <p style="margin: 16px 0; font-size: 16px; text-align: center; color: white;">Следите за новостями!</p>
                                </div>
                            </div>
                        `;
                        break;
                    case 'profile':
                console.log('Загрузка содержимого вкладки "Profile"');
                        showProfile();
                        break;
                    case 'planet':
                console.log('Загрузка содержимого вкладки "Planet"');
                        content = `
                    <h3>Планета</h3>
                            <button class="close-button" type="button">
                                <i class="material-icons">close</i>
                            </button>
                    <div class="planet-container" style="display: flex; flex-direction: column; gap: 24px; padding: 0 0 20px 0; width: 100%;">
                        <!-- Статус планеты -->
                        <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05); width: 100%; box-sizing: border-box; touch-action: auto;">
                            <div style="display: flex; align-items: center; margin-bottom: 16px; touch-action: auto;">
                                <i class="material-icons" style="font-size: 28px; color: #78AAFF; margin-right: 12px;">public</i>
                                <h4 style="margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">Состояние экосистемы</h4>
                            </div>
                            
                            <div class="pollution-info" style="margin-bottom: 16px; touch-action: auto;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; touch-action: auto;">
                                    <span style="font-size: 14px; color: rgba(255, 255, 255, 0.7);">Уровень загрязнения</span>
                                    <span id="pollution-value" style="font-size: 14px; font-weight: 600; font-family: 'Courier New', monospace;"></span>
                                </div>
                                <div style="height: 6px; width: 100%; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; margin-bottom: 8px; touch-action: auto;">
                                    <div id="pollution-bar" style="height: 100%; width: 50%; transition: width 0.5s ease, background-color 0.5s ease;"></div>
                                </div>
                                <p id="pollution-status" style="margin: 4px 0 0; font-size: 13px; color: rgba(255, 255, 255, 0.6);"></p>
                            </div>
                            
                            <div style="display: flex; align-items: center; background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 12px; margin-top: 8px; touch-action: auto;">
                                <i class="material-icons" style="font-size: 20px; color: #FFCC00; margin-right: 10px;">info_outline</i>
                                <p style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.8); line-height: 1.4;">Загрязнение автоматически увеличивается на <strong style="color: #F44336;">50%</strong> каждые 24 часа. Снижайте уровень загрязнения, чтобы получать больше EARTH токенов. Каждое действие доступно раз в 4 часа.</p>
                            </div>
                        </div>
                        
                        <!-- Действия по очистке -->
                        <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05); width: 100%; box-sizing: border-box; touch-action: auto;">
                            <div style="display: flex; align-items: center; margin-bottom: 20px; touch-action: auto;">
                                <i class="material-icons" style="font-size: 28px; color: #4CAF50; margin-right: 12px;">eco</i>
                                <h4 style="margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">Действия по защите планеты</h4>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px; touch-action: auto;">
                                <button class="action-button" data-reduction="5" data-reward="10" style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.2); padding: 16px; border-radius: 16px; display: flex; align-items: center; transition: all 0.2s ease; text-align: left; touch-action: manipulation; width: 100%; box-sizing: border-box;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(76, 175, 80, 0.2); display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0;">
                                        <i class="material-icons" style="font-size: 24px; color: #4CAF50;">nature</i>
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">Посадить дерево</div>
                                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">Снижает загрязнение на 5%</div>
                                    </div>
                                    <div style="background: rgba(76, 175, 80, 0.2); color: #4CAF50; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 8px; display: flex; align-items: center;">
                                        <i class="material-icons" style="font-size: 16px; margin-right: 4px;">toll</i>
                                        <span>+10</span>
                                    </div>
                                </button>
                                
                                <button class="action-button" data-reduction="10" data-reward="20" style="background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.2); padding: 16px; border-radius: 16px; display: flex; align-items: center; transition: all 0.2s ease; text-align: left; touch-action: manipulation; width: 100%; box-sizing: border-box;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(33, 150, 243, 0.2); display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0;">
                                        <i class="material-icons" style="font-size: 24px; color: #2196F3;">waves</i>
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">Очистить океан</div>
                                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">Снижает загрязнение на 10%</div>
                                    </div>
                                    <div style="background: rgba(33, 150, 243, 0.2); color: #2196F3; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 8px; display: flex; align-items: center;">
                                        <i class="material-icons" style="font-size: 16px; margin-right: 4px;">toll</i>
                                        <span>+20</span>
                                    </div>
                                </button>
                                
                                <button class="action-button" data-reduction="7.5" data-reward="15" style="background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.2); padding: 16px; border-radius: 16px; display: flex; align-items: center; transition: all 0.2s ease; text-align: left; touch-action: manipulation; width: 100%; box-sizing: border-box;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 152, 0, 0.2); display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0;">
                                        <i class="material-icons" style="font-size: 24px; color: #FF9800;">recycling</i>
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">Переработать отходы</div>
                                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">Снижает загрязнение на 7.5%</div>
                                    </div>
                                    <div style="background: rgba(255, 152, 0, 0.2); color: #FF9800; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 8px; display: flex; align-items: center;">
                                        <i class="material-icons" style="font-size: 16px; margin-right: 4px;">toll</i>
                                        <span>+15</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                        `;
                        break;
                    case 'tasks':
                console.log('Загрузка содержимого вкладки "Tasks"');
                        content = `
                            <h3>Available Tasks</h3>
                            <button class="close-button" type="button">
                                <i class="material-icons">close</i>
                            </button>
                            <div class="task-container">
                                <div class="task-item">
                                    <div class="task-header">
                                        <i class="material-icons">group</i>
                                        <span>Join Community</span>
                                    </div>
                                    <p class="task-description">Join our Earth Community to stay updated!</p>
                                    <button class="task-button" id="join-community-btn">
                                        <i class="material-icons">telegram</i>
                                        Join Community
                                    </button>
                                </div>
                            </div>
                        `;
                        break;
            default:
                console.error(`Неизвестная секция: ${section}`);
                return;
                }
                
        if (section !== 'profile') {
                tabInner.innerHTML = content;
        }
        
        console.log(`Содержимое вкладки ${section} загружено`);
                
                // Update close button handler
                const closeButton = tabInner.querySelector('.close-button');
        if (closeButton) {
                ['touchstart', 'click'].forEach(eventType => {
                    closeButton.addEventListener(eventType, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    console.log('Закрытие вкладки по кнопке');
                    window.closeTab();
                    }, { passive: false });
                });
        } else {
            console.warn('Кнопка закрытия не найдена в текущей вкладке');
        }
                
                // Show tab content
                tabContent.classList.add('active');
                setTimeout(() => {
                    tabInner.style.opacity = '1';
                }, 50);

        // Установка обработчиков для кнопок в зависимости от вкладки
                if (section === 'tasks') {
            setupTasksHandlers();
        } else if (section === 'planet') {
            // Специальные настройки для вкладки планеты
            tabInner.style.touchAction = 'auto'; // Разрешаем все жесты на вкладке планеты
            tabInner.style.pointerEvents = 'auto';
            tabInner.style.overscrollBehavior = 'contain';
            
            // Убеждаемся, что WebApp расширен
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
            }
            
            // Устанавливаем обработчики действий после рендеринга контента
            setTimeout(() => {
                setupPlanetActions();
                setupPlanetScrollHandlers();
            }, 50);
        }

        // Добавляем обработчик события прокрутки для эффекта размытия верхней части
        tabInner.addEventListener('scroll', function() {
            if (this.scrollTop > 10) {
                this.classList.add('scrolled');
            } else {
                this.classList.remove('scrolled');
            }
        });
        
        // Улучшаем обработку скроллинга особенно для вкладки планеты
        if (section === 'planet') {
            setTimeout(() => {
                // Принудительно устанавливаем свойства скроллинга
                tabInner.style.overflowY = 'auto';
                tabInner.style.touchAction = 'pan-y';
                tabInner.style.webkitOverflowScrolling = 'touch';
                tabInner.style.overscrollBehavior = 'contain';
                
                // Обработчик прокрутки для предотвращения сворачивания WebApp
                tabInner.addEventListener('touchstart', function(e) {
                    // Предотвращаем сворачивание если скролл в начале и пытаемся тянуть вниз
                    if (this.scrollTop <= 0) {
                        this.dataset.startY = e.touches[0].clientY;
                    }
                }, { passive: true });
                
                tabInner.addEventListener('touchmove', function(e) {
                    // Если мы в верхней части скролла и пытаемся тянуть вниз
                    if (this.scrollTop <= 0 && 
                        this.dataset.startY && 
                        e.touches[0].clientY > parseInt(this.dataset.startY)) {
                        e.preventDefault();
                        // Дополнительно расширяем WebApp для большей надежности
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.expand();
                        }
                    }
                }, { passive: false });
                
                // Принудительно включаем скроллинг для всех частей планеты
                const planetElements = tabInner.querySelectorAll('.planet-container, .action-button, .pollution-info');
                planetElements.forEach(element => {
                    if (element) {
                        element.style.overflowY = 'visible';
                        element.style.touchAction = 'pan-y';
                    }
                });
                
                // Обрабатываем загрузку контента планеты, принудительно устанавливая скроллинг
                setupPlanetScrollHandlers();
            }, 100);
        }
        
        // Расширяем Telegram WebApp при открытии вкладки
        if (window.Telegram && window.Telegram.WebApp) {
            try {
            window.Telegram.WebApp.expand();
                
                // Предотвращаем сворачивание мини-аппа
                window.Telegram.WebApp.enableClosingConfirmation();
                
                // Отключаем BackButton для предотвращения закрытия
                if (window.Telegram.WebApp.BackButton) {
                    window.Telegram.WebApp.BackButton.hide();
                }
                
                // Отключаем жест свайпа на iOS
                if (window.Telegram.WebApp.platform === 'ios') {
                    window.Telegram.WebApp.disableSwipeBack();
                }
            
                // Меняем цвет фона для соответствия открытой вкладке
                window.Telegram.WebApp.setBackgroundColor('#16161b');
                
                // Настраиваем поведение при изменении высоты вьюпорта
                window.Telegram.WebApp.onEvent('viewportChanged', function() {
                if (tabContent && tabContent.classList.contains('active')) {
                        // Убеждаемся, что прокрутка работает корректно
                        const viewportHeight = window.Telegram.WebApp.viewportHeight || window.innerHeight;
                        console.log(`Высота вьюпорта изменена: ${viewportHeight}px`);
                        
                        tabContent.style.height = `${viewportHeight}px`;
                        
                        // Убеждаемся, что контент можно прокручивать
                        tabInner.style.overscrollBehavior = 'contain';
                        tabInner.style.touchAction = 'pan-y';
                    }
                });
                
                // Немедленно получаем текущую высоту вьюпорта
                const initialHeight = window.Telegram.WebApp.viewportHeight || window.innerHeight;
                tabContent.style.height = `${initialHeight}px`;
                
                // Блокируем основной документ от прокрутки
                document.body.style.overflow = 'hidden';
                
                // Предотвращаем скрытие мини-аппа при прокрутке вкладки
                tabInner.addEventListener('touchstart', function(e) {
                    // Проверяем, находимся ли мы в верхней части прокрутки
                    if (this.scrollTop <= 0) {
                        this.dataset.lastY = e.touches[0].clientY;
                    }
                }, { passive: true });
                
                tabInner.addEventListener('touchmove', function(e) {
                    // Если уже в верхней части и пытаемся прокрутить дальше вверх
                    if (this.scrollTop <= 0 && this.dataset.lastY && e.touches[0].clientY > parseInt(this.dataset.lastY)) {
                        e.preventDefault();
                    }
                    this.dataset.lastY = e.touches[0].clientY;
                }, { passive: false });
                
                tabInner.addEventListener('scroll', function() {
                    // При достижении верха заблокируем дальнейшую прокрутку вверх
                    if (this.scrollTop <= 0) {
                        this.style.overscrollBehavior = 'none';
                    } else {
                        this.style.overscrollBehavior = 'contain';
                    }
                    
                    // Обновляем размытие вверху
                    if (this.scrollTop > 10) {
                        this.classList.add('scrolled');
                    } else {
                        this.classList.remove('scrolled');
                    }
                });
            } catch (error) {
                console.error('Ошибка при настройке Telegram WebApp для вкладки:', error);
            }
        }
        
        console.log(`Вкладка ${section} полностью настроена`);
    }

    // Функция настройки обработчиков для вкладки Tasks
    function setupTasksHandlers() {
        console.log('Настройка кнопок задач');
                    const joinButton = document.querySelector('#join-community-btn');
                    if (joinButton) {
                        ['touchstart', 'click'].forEach(eventType => {
                            joinButton.addEventListener(eventType, (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                    console.log('Открытие ссылки сообщества');
                                    window.location.href = 'https://t.me/NotEarthCommunity';
                            }, { passive: false });
                        });
        } else {
            console.warn('Кнопка подключения к сообществу не найдена');
        }
    }

    // Функция для обновления отображения баланса токенов
    function updateTokenBalance() {
        console.log('Обновление отображения баланса токенов');
        
        // Инициализируем баланс токенов, если он не установлен
        if (!localStorage.getItem('earthTokens')) {
            console.log('Инициализация начального баланса токенов');
            localStorage.setItem('earthTokens', '100');
        }
        
        // Получаем текущий баланс токенов
        let tokens = localStorage.getItem('earthTokens');
        tokens = tokens ? parseInt(tokens) : 0;
        
        console.log(`Текущий баланс токенов: ${tokens}`);
        
        // Проверяем, существует ли уже элемент баланса
        let tokenBalanceEl = document.getElementById('token-balance');
        
        // Если элемент не существует, создаем его
        if (!tokenBalanceEl) {
            console.log('Создаем элемент баланса токенов');
            tokenBalanceEl = document.createElement('div');
            tokenBalanceEl.id = 'token-balance';
            tokenBalanceEl.style.cssText = `
                position: fixed;
                top: 90px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, rgba(18, 18, 23, 0.9), rgba(34, 34, 42, 0.9));
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 16px;
                padding: 10px 18px;
                color: #FFFFFF;
                font-family: 'Courier New', monospace;
                font-weight: bold;
                font-size: 18px;
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                z-index: 997;
                display: flex;
                align-items: center;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(255, 255, 255, 0.1);
            `;
            document.body.appendChild(tokenBalanceEl);
        } else {
            // Обновляем позицию, если элемент уже существует
            tokenBalanceEl.style.top = '90px';
        }
        
        // Обновляем содержимое с белым цветом
        tokenBalanceEl.innerHTML = `
            <i class="material-icons" style="margin-right: 10px; font-size: 20px; color: #FFFFFF; text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);">toll</i>
            <span style="letter-spacing: 1.2px;">${tokens} EARTH</span>
        `;
        
        // Убеждаемся, что элемент видим
        tokenBalanceEl.style.display = 'flex';
        tokenBalanceEl.style.opacity = '1';
        
        console.log('Отображение баланса токенов обновлено');
        
        // Повторный вызов через некоторое время, если баланс не отображается в Telegram
        if (window.Telegram && window.Telegram.WebApp) {
            setTimeout(() => {
                if (!document.getElementById('token-balance') || 
                    document.getElementById('token-balance').style.display === 'none' || 
                    document.getElementById('token-balance').style.opacity === '0') {
                    console.log('Повторная попытка отображения баланса токенов');
                    updateTokenBalance();
                }
            }, 1000);
        }
    }
    
    // Функция добавления обработчиков к кнопкам действий планеты
    function setupPlanetActions() {
        console.log('Настройка действий планеты');
        
        // Получаем текущий уровень загрязнения
        let pollution = localStorage.getItem('earthPollution');
        pollution = pollution ? parseFloat(pollution) : 50;
        
        console.log(`Текущий уровень загрязнения: ${pollution}%`);
        
        // Проверяем, был ли обновлен загрязнение в соответствии с реальным временем
        checkPollutionTimeUpdate();
        
        // Обновляем отображение уровня загрязнения
        const pollutionBar = document.getElementById('pollution-bar');
        const pollutionValue = document.getElementById('pollution-value');
        const pollutionStatus = document.getElementById('pollution-status');
        
        if (pollutionBar && pollutionValue && pollutionStatus) {
            console.log('Обновляем индикаторы загрязнения');
            
            // Устанавливаем ширину полосы
            pollutionBar.style.width = `${pollution}%`;
            pollutionValue.textContent = `${pollution.toFixed(1)}%`;
            
            // Устанавливаем цвет и текст статуса в зависимости от уровня загрязнения
            if (pollution < 20) {
                pollutionBar.style.background = '#4CAF50'; // зеленый
                pollutionStatus.textContent = 'Отличное состояние, экосистема здорова';
                pollutionStatus.style.color = '#4CAF50';
            } else if (pollution < 50) {
                pollutionBar.style.background = '#FFC107'; // желтый
                pollutionStatus.textContent = 'Умеренное загрязнение, нужны действия по очистке';
                pollutionStatus.style.color = '#FFC107';
            } else if (pollution < 80) {
                pollutionBar.style.background = '#FF9800'; // оранжевый
                pollutionStatus.textContent = 'Высокое загрязнение, требуются срочные меры';
                pollutionStatus.style.color = '#FF9800';
            } else {
                pollutionBar.style.background = '#F44336'; // красный
                pollutionStatus.textContent = 'Критический уровень, планета в опасности!';
                pollutionStatus.style.color = '#F44336';
            }
        } else {
            console.error('Элементы индикаторов загрязнения не найдены!');
        }
        
        // Обрабатываем нажатие на кнопки очистки
        const actionButtons = document.querySelectorAll('.action-button');
        console.log(`Найдено ${actionButtons.length} кнопок действий`);
        
        if (!actionButtons.length) {
            console.error('Кнопки действий не найдены!');
            return;
        }
        
        // Функция проверки доступности кнопки (последнее использование должно быть не менее 4 часов назад)
        function isButtonAvailable(buttonId) {
            const lastUsed = localStorage.getItem(`action_${buttonId}_lastUsed`);
            if (!lastUsed) return true;
            
            const now = new Date().getTime();
            const lastUsedTime = parseInt(lastUsed);
            const hoursDiff = (now - lastUsedTime) / (1000 * 60 * 60); // разница в часах
            
            return hoursDiff >= 4;
        }
        
        // Функция для получения оставшегося времени до доступности кнопки
        function getTimeRemaining(buttonId) {
            const lastUsed = localStorage.getItem(`action_${buttonId}_lastUsed`);
            if (!lastUsed) return null;
            
            const now = new Date().getTime();
            const lastUsedTime = parseInt(lastUsed);
            const diffMs = now - lastUsedTime;
            const fourHoursMs = 4 * 60 * 60 * 1000;
            
            if (diffMs >= fourHoursMs) return null;
            
            const remainingMs = fourHoursMs - diffMs;
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return { hours, minutes };
        }
        
        actionButtons.forEach((button, index) => {
            console.log(`Настройка кнопки действия ${index}`);
            
            // Присваиваем уникальный ID каждой кнопке, если его нет
            if (!button.id) {
                button.id = `action-button-${index}`;
            }
            
            // Проверяем доступность кнопки
            const buttonId = button.id;
            const isAvailable = isButtonAvailable(buttonId);
            const timeRemaining = getTimeRemaining(buttonId);
            
            // Удаляем предыдущие обработчики, чтобы избежать дублирования
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Если кнопка недоступна, обновляем её внешний вид
            if (!isAvailable && timeRemaining) {
                // Сохраняем оригинальный контент для восстановления
                const originalContent = newButton.innerHTML;
                
                // Делаем кнопку неактивной
                newButton.disabled = true;
                newButton.style.opacity = '0.6';
                newButton.style.cursor = 'not-allowed';
                
                // Добавляем информацию о времени до разблокировки
                const timeText = `${timeRemaining.hours}ч ${timeRemaining.minutes}м`;
                
                // Находим div для описания действия (третий div в кнопке)
                const descriptionDiv = newButton.querySelectorAll('div')[2];
                if (descriptionDiv) {
                    // Сохраняем оригинальный текст
                    const originalDescription = descriptionDiv.innerHTML;
                    
                    // Обновляем с информацией о времени
                    descriptionDiv.innerHTML = `
                        <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">
                            <span style="color: #FF9800;">Перезарядка</span>
                        </div>
                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                            Доступно через ${timeText}
                        </div>
                    `;
                    
                    // Обновляем кнопку каждую минуту для обновления обратного отсчета
                    const updateTimer = setInterval(() => {
                        const updatedTime = getTimeRemaining(buttonId);
                        
                        if (!updatedTime) {
                            // Кнопка стала доступна
                            clearInterval(updateTimer);
                            newButton.disabled = false;
                            newButton.style.opacity = '1';
                            newButton.style.cursor = 'pointer';
                            
                            // Восстанавливаем оригинальное содержимое
                            if (descriptionDiv) {
                                descriptionDiv.innerHTML = originalDescription;
                            }
                            setupButtonListeners(newButton);
                            return;
                        }
                        
                        const timeText = `${updatedTime.hours}ч ${updatedTime.minutes}м`;
                        descriptionDiv.innerHTML = `
                            <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">
                                <span style="color: #FF9800;">Перезарядка</span>
                            </div>
                            <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                                Доступно через ${timeText}
                            </div>
                        `;
                    }, 60000); // обновляем каждую минуту
                }
                
                // Добавляем обработчик только для отображения сообщения
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Показываем сообщение о недоступности
                    alert(`Это действие будет доступно через ${timeText}`);
                });
            } else {
                // Если кнопка доступна, добавляем стандартные обработчики
                setupButtonListeners(newButton);
            }
        });
        
        // Общая функция настройки обработчиков для доступных кнопок
        function setupButtonListeners(button) {
            button.addEventListener('click', function() {
                const reduction = parseFloat(this.getAttribute('data-reduction'));
                const reward = parseInt(this.getAttribute('data-reward'));
                const buttonId = this.id;
                
                console.log(`Действие: снижение загрязнения на ${reduction}%, награда ${reward} токенов`);
                
                // Сохраняем время использования кнопки
                localStorage.setItem(`action_${buttonId}_lastUsed`, new Date().getTime().toString());
                
                // Получаем текущий уровень загрязнения
                let pollution = localStorage.getItem('earthPollution');
                pollution = pollution ? parseFloat(pollution) : 50;
                
                // Получаем текущий баланс токенов
                let tokens = localStorage.getItem('earthTokens');
                tokens = tokens ? parseInt(tokens) : 0;
                
                // Снижаем загрязнение и начисляем токены
                pollution = Math.max(0, pollution - reduction);
                tokens += reward;
                
                console.log(`Новый уровень загрязнения: ${pollution}%, новый баланс: ${tokens} токенов`);
                
                // Сохраняем новые значения
                localStorage.setItem('earthPollution', pollution.toString());
                localStorage.setItem('earthTokens', tokens.toString());
                
                // Обновляем отображение баланса токенов
                updateTokenBalance();
                
                // Создаем эффект пульсации токена при начислении
                const tokenBalanceEl = document.getElementById('token-balance');
                if (tokenBalanceEl) {
                    tokenBalanceEl.style.animation = 'pulse 0.5s ease';
                    setTimeout(() => {
                        tokenBalanceEl.style.animation = '';
                    }, 500);
                }
                
                // Временно показываем сообщение об успехе
                const originalContent = this.innerHTML;
                const originalBackground = this.style.background;
                
                this.style.background = 'rgba(76, 175, 80, 0.2)';
                this.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; width: 100%;">
                        <i class="material-icons" style="color: #4CAF50; margin-right: 8px;">check_circle</i>
                        <span style="color: #4CAF50; font-weight: 500;">Успешно!</span>
                    </div>
                `;
                
                // Обновляем отображение полосы загрязнения
                const pollutionBar = document.getElementById('pollution-bar');
                const pollutionValue = document.getElementById('pollution-value');
                const pollutionStatus = document.getElementById('pollution-status');
                
                if (pollutionBar && pollutionValue && pollutionStatus) {
                    // Плавно меняем ширину полосы
                    pollutionBar.style.transition = 'width 0.5s ease, background-color 0.5s ease';
                    pollutionBar.style.width = `${pollution}%`;
                    pollutionValue.textContent = `${pollution.toFixed(1)}%`;
                    
                    // Обновляем цвет и текст статуса
                    if (pollution < 20) {
                        pollutionBar.style.background = '#4CAF50'; // зеленый
                        pollutionStatus.textContent = 'Отличное состояние, экосистема здорова';
                        pollutionStatus.style.color = '#4CAF50';
                    } else if (pollution < 50) {
                        pollutionBar.style.background = '#FFC107'; // желтый
                        pollutionStatus.textContent = 'Умеренное загрязнение, нужны действия по очистке';
                        pollutionStatus.style.color = '#FFC107';
                    } else if (pollution < 80) {
                        pollutionBar.style.background = '#FF9800'; // оранжевый
                        pollutionStatus.textContent = 'Высокое загрязнение, требуются срочные меры';
                        pollutionStatus.style.color = '#FF9800';
                    } else {
                        pollutionBar.style.background = '#F44336'; // красный
                        pollutionStatus.textContent = 'Критический уровень, планета в опасности!';
                        pollutionStatus.style.color = '#F44336';
                    }
                }
                
                // Блокируем кнопку 
                this.disabled = true;
                
                // Через 2 секунды меняем внешний вид на недоступную кнопку
                setTimeout(() => {
                    this.disabled = true;
                    this.style.opacity = '0.6';
                    this.style.cursor = 'not-allowed';
                    this.style.background = originalBackground;
                    
                    // Находим div для описания действия (третий div в кнопке)
                    const descriptionDiv = this.querySelectorAll('div')[2];
                    if (descriptionDiv) {
                        descriptionDiv.innerHTML = `
                            <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">
                                <span style="color: #FF9800;">Перезарядка</span>
                            </div>
                            <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                                Доступно через 4ч 0м
                            </div>
                        `;
                    }
                    
                    // Удаляем текущий обработчик и добавляем новый для отображения сообщения
                    this.replaceWith(this.cloneNode(true));
                    setupPlanetActions(); // Перенастраиваем все кнопки
                }, 2000);
            });
            
            // Добавляем также обработчик touchend для лучшей мобильной поддержки
            button.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!this.disabled) {
                    this.click(); // Имитируем клик
                }
            }, { passive: false });
        }
    }
    
    // Функция для проверки и обновления загрязнения в соответствии с реальным временем
    function checkPollutionTimeUpdate() {
        console.log('Проверка и обновление уровня загрязнения по времени');
        
        // Получаем текущее время и последнее время обновления
        const currentTime = new Date().getTime();
        let lastUpdateTime = localStorage.getItem('pollutionLastUpdateTime');
        
        // Если нет записи о последнем обновлении, создаем её
        if (!lastUpdateTime) {
            localStorage.setItem('pollutionLastUpdateTime', currentTime.toString());
            console.log('Установлено начальное время последнего обновления загрязнения');
            return;
        }
        
        lastUpdateTime = parseInt(lastUpdateTime);
        
        // Разница во времени в миллисекундах
        const timeDifference = currentTime - lastUpdateTime;
        
        // Количество часов, прошедших с последнего обновления
        const hoursPassed = timeDifference / (1000 * 60 * 60);
        
        // Если прошло хотя бы 24 часа (86400000 мс)
        if (hoursPassed >= 24) {
            console.log(`Прошло ${hoursPassed.toFixed(2)} часов с последнего обновления`);
            
            // Количество полных дней
            const daysPassed = Math.floor(hoursPassed / 24);
            
            // Получаем текущий уровень загрязнения
            let pollution = localStorage.getItem('earthPollution');
            pollution = pollution ? parseFloat(pollution) : 50;
            
            // Увеличиваем загрязнение на 50% за каждый прошедший день
            for (let i = 0; i < daysPassed; i++) {
                pollution = Math.min(100, pollution + 50);
                console.log(`День ${i+1}: загрязнение увеличено до ${pollution}%`);
            }
            
            // Сохраняем новое значение загрязнения
            localStorage.setItem('earthPollution', pollution.toString());
            
            // Обновляем время последнего обновления, учитывая только полные прошедшие дни
            const newLastUpdateTime = lastUpdateTime + (daysPassed * 24 * 60 * 60 * 1000);
            localStorage.setItem('pollutionLastUpdateTime', newLastUpdateTime.toString());
            
            console.log(`Загрязнение обновлено: ${pollution}%, следующее обновление через 24 часа`);
            
            // Если у нас есть функция обновления внешнего вида планеты, вызываем её
            if (window.dispatchEvent) {
                window.dispatchEvent(new CustomEvent('pollutionChanged', { 
                    detail: { level: pollution } 
                }));
            }
        } else {
            console.log(`С последнего обновления прошло ${hoursPassed.toFixed(2)} часов, следующее обновление через ${(24 - hoursPassed).toFixed(2)} часов`);
        }
    }

    // Обновляем информацию о задачах
    function setupTasksTab() {
        const tasksInfo = `
            <div class="tasks-info">
                <h2>Задания по спасению планеты</h2>
                <p>
                    Загрязнение планеты увеличивается на <strong style="color: #F44336;">50%</strong> каждые 24 часа.
                    Выполняйте действия для снижения уровня загрязнения и получения токенов.
                </p>
                <p>
                    Каждое действие доступно один раз в 4 часа.
                </p>
                <p>
                    Заходите в приложение ежедневно, чтобы не допустить критического уровня загрязнения!
                </p>
            </div>
        `;
        
        // Вставляем информацию в таб задач, когда он открывается
        const tabContent = document.querySelector('.tab-content-inner');
        if (tabContent) {
            // Вставляем информацию о задачах при открытии вкладки Tasks
            const tasksBtn = document.querySelector('.nav-button[data-section="tasks"]');
            if (tasksBtn) {
                tasksBtn.addEventListener('click', function() {
                    if (tabContent.innerHTML.indexOf('tasks-info') === -1) {
                        tabContent.innerHTML = tasksInfo + tabContent.innerHTML;
                    }
                });
            }
        }
    }

    // Запускаем первую проверку времени при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Проверяем время и обновляем загрязнение при загрузке страницы
        checkPollutionTimeUpdate();
        
        // Настраиваем регулярные проверки каждый час
        setInterval(checkPollutionTimeUpdate, 60 * 60 * 1000);
        
        // Добавляем информацию в таб заданий
        setupTasksTab();
    });

    // Показываем панель навигации при первом касании экрана
    let isFirstTouch = true;
    
    document.addEventListener('touchstart', function(e) {
        if (isFirstTouch) {
            console.log('Первое касание, показываем панель навигации');
            const navPanel = document.querySelector('.nav-panel');
            if (navPanel) {
                navPanel.classList.add('visible');
            }
            isFirstTouch = false;
        }
    }, { passive: true });
    
    // Инициализируем баланс токенов, если он не установлен
    if (!localStorage.getItem('earthTokens')) {
        console.log('Инициализация начального баланса токенов');
        localStorage.setItem('earthTokens', '100');
    }
    
    // Инициализируем уровень загрязнения, если он не установлен
    if (!localStorage.getItem('earthPollution')) {
        console.log('Инициализация начального уровня загрязнения');
        localStorage.setItem('earthPollution', '50');
        localStorage.setItem('pollutionLastUpdate', new Date().toDateString());
    }
    
    // Функция для принудительной инициализации UI в Telegram WebApp
    function forceUIInitialization() {
        console.log('Принудительная инициализация UI');
        
        // Показываем панель навигации
        const navPanel = document.querySelector('.nav-panel');
        if (navPanel) {
            navPanel.classList.add('visible');
            console.log('Панель навигации показана принудительно');
        }
        
        // Обновляем отображение баланса токенов
        updateTokenBalance();
        
        // Если есть активная вкладка, обновляем ее
        const activeButton = document.querySelector('.nav-button.active');
        if (activeButton) {
            const section = activeButton.getAttribute('data-section');
            if (section) {
                console.log(`Переоткрытие активной вкладки ${section}`);
                handleNavClick(section, activeButton);
            }
        }
    }
    
    // Если это Telegram WebApp, запустим принудительную инициализацию через некоторое время
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.onEvent('mainButtonClicked', forceUIInitialization);
        
        // Показываем временно MainButton, чтобы пользователь мог инициализировать UI если автоматически не сработало
        setTimeout(() => {
            if (!document.getElementById('token-balance') || !document.querySelector('.nav-panel.visible')) {
                console.log('UI не инициализирован, показываем кнопку для ручной инициализации');
                
                try {
                    window.Telegram.WebApp.MainButton.setText('Показать интерфейс');
                    window.Telegram.WebApp.MainButton.show();
                    
                    // Таймер автоматического закрытия кнопки
                    setTimeout(() => {
                        window.Telegram.WebApp.MainButton.hide();
                        forceUIInitialization();
                    }, 5000);
                } catch (error) {
                    console.error('Ошибка при отображении кнопки инициализации:', error);
                    forceUIInitialization();
                }
            }
        }, 2000);
        
        // В любом случае, принудительно инициализируем через некоторое время
        setTimeout(forceUIInitialization, 3000);
    }
    </script>
    <script>
    // Функция показа профиля
    function showProfile() {
        const tabInner = document.querySelector('.tab-content-inner');
        
        // Получаем информацию о пользователе и количестве токенов
        let tokens = localStorage.getItem('earthTokens');
        tokens = tokens ? parseInt(tokens) : 0;
        
        // Определяем рейтинг на основе токенов с новой шкалой
        let rating = "";
        let ratingColor = "";
        let ratingTitle = "";
        
        if (tokens >= 100000) {
            rating = "S";
            ratingColor = "#FFD700"; // золотой
            ratingTitle = "Защитник планеты";
        } else if (tokens >= 10000) {
            rating = "A";
            ratingColor = "#4CAF50"; // зеленый
            ratingTitle = "Эколог";
        } else if (tokens >= 1000) {
            rating = "B";
            ratingColor = "#2196F3"; // синий
            ratingTitle = "Хранитель природы"; 
        } else if (tokens >= 100) {
            rating = "C";
            ratingColor = "#FFC107"; // желтый
            ratingTitle = "Начинающий эколог";
        } else {
            rating = "D";
            ratingColor = "#FF9800"; // оранжевый
            ratingTitle = "Новичок";
        }
        
        // Создаем аватар с эмодзи земли
        const avatarStyle = `
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.8), rgba(66, 165, 245, 0.8));
            border-radius: 50%;
            font-size: 36px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        `;
            
        tabInner.innerHTML = `
            <h3>Профиль</h3>
            <button class="close-button" type="button">
                <i class="material-icons">close</i>
            </button>
            <div class="profile-container" style="display: flex; flex-direction: column; gap: 24px; padding: 0 0 40px 0; width: 100%; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;">
                <!-- Основная информация профиля -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05); width: 100%; box-sizing: border-box; touch-action: auto; pointer-events: auto;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <!-- Аватар с эмодзи земли -->
                        <div style="${avatarStyle}">
                            <span style="font-size: 42px;">🌍</span>
                        </div>
                        
                        <!-- Информация пользователя -->
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 6px 0; font-size: 18px; font-weight: 600;">Пользователь Earth 3D</h4>
                            <p style="margin: 0; font-size: 14px; color: rgba(255, 255, 255, 0.6);">${ratingTitle}</p>
                        </div>
                        
                        <!-- Рейтинг -->
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px;">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(${ratingColor === '#FFD700' ? '255, 215, 0' : ratingColor === '#4CAF50' ? '76, 175, 80' : ratingColor === '#2196F3' ? '33, 150, 243' : ratingColor === '#FFC107' ? '255, 193, 7' : '255, 152, 0'}, 0.15); display: flex; align-items: center; justify-content: center; margin-bottom: 4px;">
                                <span style="font-weight: 700; font-size: 24px; color: ${ratingColor};">${rating}</span>
                            </div>
                            <span style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">Рейтинг</span>
                        </div>
                    </div>
                </div>
                
                <!-- Статистика токенов -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05); width: 100%; box-sizing: border-box; touch-action: auto; pointer-events: auto;">
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <i class="material-icons" style="font-size: 28px; color: #FFD700; margin-right: 12px;">toll</i>
                        <h4 style="margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">Токены EARTH</h4>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 16px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 14px; color: rgba(255, 255, 255, 0.6);">Текущий баланс</p>
                            <h3 style="margin: 8px 0 0 0; font-size: 28px; font-weight: 700; font-family: 'Courier New', monospace; letter-spacing: 0.5px;">${tokens}</h3>
                        </div>
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255, 215, 0, 0.1); display: flex; align-items: center; justify-content: center;">
                            <i class="material-icons" style="font-size: 24px; color: #FFD700;">toll</i>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 12px;">
                        <div style="display: flex; align-items: center;">
                            <i class="material-icons" style="font-size: 20px; color: #FFCC00; margin-right: 10px;">info_outline</i>
                            <p style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.8); line-height: 1.4;">
                                Токены EARTH начисляются за выполнение действий по защите планеты. Чем больше токенов, тем выше ваш рейтинг.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Таблица рейтингов -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05); width: 100%; box-sizing: border-box; touch-action: auto; pointer-events: auto;">
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <i class="material-icons" style="font-size: 28px; color: #64B5F6; margin-right: 12px;">leaderboard</i>
                        <h4 style="margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">Система рейтингов</h4>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; align-items: center; padding: 10px; border-radius: 12px; background: ${rating === 'S' ? 'rgba(255, 215, 0, 0.1)' : 'rgba(255, 255, 255, 0.05)'}; border: 1px solid ${rating === 'S' ? 'rgba(255, 215, 0, 0.2)' : 'rgba(255, 255, 255, 0.05)'};">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(255, 215, 0, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="font-weight: 700; font-size: 18px; color: #FFD700;">S</span>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Защитник планеты</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">100,000+ токенов</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 10px; border-radius: 12px; background: ${rating === 'A' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 255, 255, 0.05)'}; border: 1px solid ${rating === 'A' ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 255, 255, 0.05)'};">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(76, 175, 80, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="font-weight: 700; font-size: 18px; color: #4CAF50;">A</span>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Эколог</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">10,000+ токенов</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 10px; border-radius: 12px; background: ${rating === 'B' ? 'rgba(33, 150, 243, 0.1)' : 'rgba(255, 255, 255, 0.05)'}; border: 1px solid ${rating === 'B' ? 'rgba(33, 150, 243, 0.2)' : 'rgba(255, 255, 255, 0.05)'};">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(33, 150, 243, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="font-weight: 700; font-size: 18px; color: #2196F3;">B</span>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Хранитель природы</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">1,000+ токенов</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 10px; border-radius: 12px; background: ${rating === 'C' ? 'rgba(255, 193, 7, 0.1)' : 'rgba(255, 255, 255, 0.05)'}; border: 1px solid ${rating === 'C' ? 'rgba(255, 193, 7, 0.2)' : 'rgba(255, 255, 255, 0.05)'};">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(255, 193, 7, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="font-weight: 700; font-size: 18px; color: #FFC107;">C</span>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Начинающий эколог</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">100+ токенов</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 10px; border-radius: 12px; background: ${rating === 'D' ? 'rgba(255, 152, 0, 0.1)' : 'rgba(255, 255, 255, 0.05)'}; border: 1px solid ${rating === 'D' ? 'rgba(255, 152, 0, 0.2)' : 'rgba(255, 255, 255, 0.05)'};">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(255, 152, 0, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="font-weight: 700; font-size: 18px; color: #FF9800;">D</span>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Новичок</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">0-99 токенов</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Дополнительный блок для демонстрации скроллинга -->
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05); width: 100%; box-sizing: border-box; touch-action: auto; pointer-events: auto;">
                    <div style="display: flex; align-items: center; margin-bottom: 16px;">
                        <i class="material-icons" style="font-size: 28px; color: #4CAF50; margin-right: 12px;">eco</i>
                        <h4 style="margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">Статистика эко-активности</h4>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; align-items: center; padding: 12px; border-radius: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(76, 175, 80, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="material-icons" style="font-size: 18px; color: #4CAF50;">park</i>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Посаженные деревья</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Пока нет данных</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; border-radius: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(33, 150, 243, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="material-icons" style="font-size: 18px; color: #2196F3;">water</i>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Очищенные океаны</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Пока нет данных</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; border-radius: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(255, 193, 7, 0.15); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <i class="material-icons" style="font-size: 18px; color: #FFC107;">recycling</i>
                            </div>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 14px; font-weight: 500;">Переработанные отходы</p>
                                <p style="margin: 2px 0 0 0; font-size: 12px; color: rgba(255, 255, 255, 0.6);">Пока нет данных</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Добавляем обработчик для кнопки закрытия
        const closeButton = tabInner.querySelector('.close-button');
        if (closeButton) {
            closeButton.addEventListener('click', function() {
                window.closeTab();
            });
        }
        
        // Настраиваем скроллинг для вкладки профиля
        setupProfileScrollHandlers();
    }
    
    // Функция для настройки скроллинга вкладки профиля (по аналогии с планетой)
    function setupProfileScrollHandlers() {
        console.log('Настройка обработчиков скроллинга для вкладки профиля');
        
        // Корректируем контейнеры для правильного скроллинга
        const profileContainer = document.querySelector('.profile-container');
        const tabInner = document.querySelector('.tab-content-inner');
        const tabContent = document.querySelector('.tab-content');
        
        if (profileContainer && tabInner && tabContent) {
            // Убеждаемся, что WebApp развернут
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.enableClosingConfirmation();
                if (window.Telegram.WebApp.BackButton) {
                    window.Telegram.WebApp.BackButton.hide();
                }
            }
            
            // Настраиваем CSS-свойства для вкладки профиля
            tabContent.style.overscrollBehavior = 'none';
            
            // Настройка внутреннего контейнера вкладки
            tabInner.style.overscrollBehavior = 'contain';
            tabInner.style.overscrollBehaviorY = 'contain';
            tabInner.style.touchAction = 'pan-y';
            tabInner.style.webkitOverflowScrolling = 'touch';
            tabInner.style.overflow = 'auto';
            
            // Настройка контейнера профиля
            profileContainer.style.overflowY = 'auto'; // Изменяем с 'initial' на 'auto' для полноценного скроллинга
            profileContainer.style.touchAction = 'pan-y'; // Изменяем с 'auto' на 'pan-y' для вертикального скроллинга
            profileContainer.style.webkitOverflowScrolling = 'touch';
            profileContainer.style.overscrollBehavior = 'contain';
            profileContainer.style.width = '100%';
            profileContainer.style.minHeight = 'min-content';
            profileContainer.style.height = '100%'; // Добавляем полную высоту для правильного скроллинга
            
            // Исправляем все элементы внутри вкладки профиля для корректного скроллинга
            const profileElements = profileContainer.querySelectorAll('div'); // Изменяем селектор для захвата всех div внутри контейнера
            profileElements.forEach(element => {
                element.style.touchAction = 'auto';
                element.style.pointerEvents = 'auto';
            });
            
            // Сохраняем начальную позицию касания для обработки
            let touchStartY = 0;
            
            // Удаляем существующие обработчики, чтобы избежать дублирования
            profileContainer.removeEventListener('touchstart', profileTouchStartHandler); // Меняем tabInner на profileContainer
            profileContainer.removeEventListener('touchmove', profileTouchMoveHandler);
            profileContainer.removeEventListener('scroll', profileScrollHandler);
            
            // Настраиваем обработчики сенсорных событий
            function profileTouchStartHandler(e) {
                touchStartY = e.touches[0].clientY;
                
                // Расширяем WebApp при каждом касании
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.expand();
                }
            }
            
            function profileTouchMoveHandler(e) {
                // Если в верхней части скролла и пытаемся скроллить вниз
                if (profileContainer.scrollTop <= 0 && e.touches[0].clientY > touchStartY) { // Меняем tabInner на profileContainer
                    // Предотвращаем скролл, который может привести к сворачиванию
                    e.preventDefault();
                    
                    // Принудительно разворачиваем WebApp
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                }
            }
            
            function profileScrollHandler() {
                // При достижении верха примениям особую обработку
                if (this.scrollTop <= 0) {
                    this.style.overscrollBehavior = 'none';
                    
                    // Расширяем WebApp при достижении верха
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                } else {
                    this.style.overscrollBehavior = 'contain';
                }
                
                // Обновляем размытие вверху при скролле
                if (this.scrollTop > 10) {
                    this.classList.add('scrolled');
                } else {
                    this.classList.remove('scrolled');
                }
            }
            
            // Добавляем обработчики
            profileContainer.addEventListener('touchstart', profileTouchStartHandler, { passive: false }); // Меняем tabInner на profileContainer
            profileContainer.addEventListener('touchmove', profileTouchMoveHandler, { passive: false });
            profileContainer.addEventListener('scroll', profileScrollHandler, { passive: true });
            
            console.log('Обработчики скроллинга для вкладки профиля настроены');
        } else {
            console.error('Не найдены необходимые элементы для настройки скроллинга профиля');
        }
    }
    </script>
    <script>
    // Добавляем функцию для настройки скроллинга планеты
    function setupPlanetScrollHandlers() {
        console.log('Настройка обработчиков скроллинга для вкладки планеты');
        
        // Корректируем контейнеры для правильного скроллинга
        const planetContainer = document.querySelector('.planet-container');
        const tabInner = document.querySelector('.tab-content-inner');
        const tabContent = document.querySelector('.tab-content');
        
        if (planetContainer && tabInner && tabContent) {
            // Убеждаемся, что WebApp развернут и подготовлен для скроллинга
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.enableClosingConfirmation();
                if (window.Telegram.WebApp.BackButton) {
                    window.Telegram.WebApp.BackButton.hide();
                }
            }
            
            // Настраиваем CSS-свойства для вкладки планеты
            tabContent.style.overscrollBehavior = 'none';
            
            // Настройка внутреннего контейнера вкладки - ключевые изменения для скроллинга
            tabInner.style.overscrollBehavior = 'contain';
            tabInner.style.overscrollBehaviorY = 'contain';
            tabInner.style.touchAction = 'pan-y';
            tabInner.style.webkitOverflowScrolling = 'touch';
            tabInner.style.overflow = 'auto';
            
            // Настройка контейнера планеты - ключевые изменения для скроллинга
            planetContainer.style.overflowY = 'initial'; // не ограничиваем скролл внутри контейнера
            planetContainer.style.touchAction = 'auto'; // разрешаем все стандартные жесты
            planetContainer.style.webkitOverflowScrolling = 'touch';
            planetContainer.style.overscrollBehavior = 'contain';
            planetContainer.style.width = '100%';
            planetContainer.style.minHeight = 'min-content'; // разрешаем свободную высоту
            
            // Исправляем все элементы внутри вкладки планеты для корректного скроллинга
            const planetElements = tabInner.querySelectorAll('.planet-container > div');
            planetElements.forEach(element => {
                element.style.touchAction = 'auto';
                element.style.pointerEvents = 'auto';
            });
            
            // Настройка скроллинга для кнопок и интерактивных элементов
            const actionButtons = document.querySelectorAll('.action-button');
            actionButtons.forEach(button => {
                button.style.touchAction = 'manipulation';
                button.style.webkitTapHighlightColor = 'transparent';
                button.style.pointerEvents = 'auto';
            });
            
            // Сохраняем начальную позицию касания для обработки
            let touchStartY = 0;
            
            // Удаляем существующие обработчики, чтобы избежать дублирования
            tabInner.removeEventListener('touchstart', planetTouchStartHandler);
            tabInner.removeEventListener('touchmove', planetTouchMoveHandler);
            tabInner.removeEventListener('scroll', planetScrollHandler);
            
            // Настраиваем обработчики сенсорных событий
            function planetTouchStartHandler(e) {
                touchStartY = e.touches[0].clientY;
                
                // Расширяем WebApp при каждом касании
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.expand();
                }
            }
            
            function planetTouchMoveHandler(e) {
                // Если в верхней части скролла и пытаемся скроллить вниз
                if (tabInner.scrollTop <= 0 && e.touches[0].clientY > touchStartY) {
                    // Предотвращаем скролл, который может привести к сворачиванию
                    e.preventDefault();
                    
                    // Принудительно разворачиваем WebApp
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                }
            }
            
            function planetScrollHandler() {
                // При достижении верха примениям особую обработку
                if (this.scrollTop <= 0) {
                    this.style.overscrollBehavior = 'none';
                    
                    // Расширяем WebApp при достижении верха
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                } else {
                    this.style.overscrollBehavior = 'contain';
                }
                
                // Обновляем размытие вверху при скролле
                if (this.scrollTop > 10) {
                    this.classList.add('scrolled');
                } else {
                    this.classList.remove('scrolled');
                }
            }
            
            // Добавляем обработчики
            tabInner.addEventListener('touchstart', planetTouchStartHandler, { passive: false });
            tabInner.addEventListener('touchmove', planetTouchMoveHandler, { passive: false });
            tabInner.addEventListener('scroll', planetScrollHandler, { passive: true });
            
            console.log('Обработчики скроллинга для вкладки планеты настроены');
        } else {
            console.error('Не найдены необходимые элементы для настройки скроллинга планеты');
        }
    }
    </script>
</body>
</html>