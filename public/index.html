<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earth 3D</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            image-rendering: pixelated;
            overscroll-behavior: none;
            position: fixed;
            background: #000000;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
        }
        body * {
            overscroll-behavior: none;
            touch-action: none;
        }
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            touch-action: none;
            z-index: 1;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        #loading-container {
            position: relative;
            width: 100px;
            height: 100px;
        }
        #loading-earth {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 48px;
            height: 48px;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg,
                #1a237e 0%, #1a237e 10%,    /* Темно-синий */
                #283593 10%, #283593 20%,   /* Синий */
                #3949ab 20%, #3949ab 30%,   /* Светло-синий */
                #42a5f5 30%, #42a5f5 40%,   /* Голубой (океаны) */
                #81c784 40%, #81c784 50%,   /* Зеленый (континенты) */
                #42a5f5 50%, #42a5f5 60%,   /* Голубой */
                #3949ab 60%, #3949ab 70%,   /* Светло-синий */
                #283593 70%, #283593 80%,   /* Синий */
                #1a237e 80%, #1a237e 90%,   /* Темно-синий */
                #0d47a1 90%, #0d47a1 100%   /* Глубокий синий */
            );
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(66, 165, 245, 0.5);
            image-rendering: pixelated;
        }
        #loading-moon {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: linear-gradient(45deg,
                #9e9e9e 0%, #9e9e9e 25%,    /* Светло-серый */
                #757575 25%, #757575 50%,   /* Серый */
                #616161 50%, #616161 75%,   /* Темно-серый */
                #424242 75%, #424242 100%   /* Очень темно-серый */
            );
            border-radius: 50%;
            transform-origin: 30px center;
            box-shadow: 0 0 5px rgba(158, 158, 158, 0.5);
            image-rendering: pixelated;
        }
        @keyframes rotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(90deg); }
            50% { transform: translate(-50%, -50%) rotate(180deg); }
            75% { transform: translate(-50%, -50%) rotate(270deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes orbit {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateX(30px); }
            25% { transform: translate(-50%, -50%) rotate(90deg) translateX(30px); }
            50% { transform: translate(-50%, -50%) rotate(180deg) translateX(30px); }
            75% { transform: translate(-50%, -50%) rotate(270deg) translateX(30px); }
            100% { transform: translate(-50%, -50%) rotate(360deg) translateX(30px); }
        }
        @keyframes explosion {
            0% { 
                transform: translate(-50%, -50%);
                clip-path: polygon(50% 0%, 60% 40%, 100% 50%, 60% 60%, 50% 100%, 40% 60%, 0% 50%, 40% 40%);
                opacity: 1;
            }
            50% { 
                transform: translate(-50%, -50%) rotate(45deg) scale(1.5);
                clip-path: polygon(50% 0%, 65% 35%, 100% 50%, 65% 65%, 50% 100%, 35% 65%, 0% 50%, 35% 35%);
                opacity: 0.7;
            }
            100% { 
                transform: translate(-50%, -50%) rotate(90deg) scale(3);
                clip-path: polygon(50% 0%, 70% 30%, 100% 50%, 70% 70%, 50% 100%, 30% 70%, 0% 50%, 30% 30%);
                opacity: 0;
            }
        }
        .explosion-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(45deg,
                #fff 0%, #fff 50%,
                #ccc 50%, #ccc 100%
            );
            border-radius: 2px;
            pointer-events: none;
            image-rendering: pixelated;
        }
        .nav-panel {
            position: fixed;
            bottom: -100px; /* Начальная позиция за пределами экрана */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(18, 18, 23, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 8px;
            display: flex; /* Всегда flex, но скрыт за пределами экрана */
            gap: 16px;
            z-index: 998;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-panel.visible {
            bottom: 20px;
            opacity: 1;
        }
        .nav-button {
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            pointer-events: auto;
        }
        .nav-button i {
            font-size: 24px;
            pointer-events: none;
            transition: transform 0.3s ease;
        }
        .nav-button:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .nav-button:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .nav-button:hover i {
            transform: scale(1.1);
        }
        .nav-button.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .tab-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgb(22, 22, 27);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), border-radius 0.3s ease;
            z-index: 999;
            pointer-events: none;
            will-change: transform, border-radius;
        }
        .tab-content.active {
            transform: translateY(60px);
            pointer-events: auto;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
        }
        .tab-content.dragging {
            transition: none;
        }
        .tab-content.closing {
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1), border-radius 0.3s ease;
        }
        .tab-content-inner {
            width: 100%;
            height: calc(100% - 60px);
            padding: 24px;
            box-sizing: border-box;
            color: rgba(255, 255, 255, 0.9);
            opacity: 0;
            transition: opacity 0.3s ease;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }
        .profile-connecting {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            margin-top: 40px;
        }
        .profile-connecting i {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 16px;
        }
        .profile-connecting h4 {
            font-size: 20px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 8px 0;
        }
        .profile-connecting p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            line-height: 1.5;
        }
        .profile-header {
            position: sticky;
            top: 24px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 40px 0 24px 0;
            padding: 20px;
            background: rgba(18, 18, 23, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            flex-wrap: wrap;
        }
        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-info {
            flex: 1;
            min-width: 0;
        }
        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin: 0 0 4px 0;
            letter-spacing: -0.02em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .profile-bio {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .profile-rating {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            text-align: center;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-left: auto;
        }
        .rating-number {
            font-size: 24px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin: 0;
            line-height: 1;
            letter-spacing: -0.02em;
        }
        .rating-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .rating-list-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 24px;
            margin: 0 -24px;
            position: relative;
            height: calc(100% - 180px);
            touch-action: pan-y;
            pointer-events: auto;
        }
        .rating-list {
            list-style: none;
            margin: 0;
            padding: 0;
            touch-action: pan-y;
            pointer-events: auto;
        }
        .rating-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            touch-action: pan-y;
            pointer-events: auto;
        }
        .rating-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .rating-item.current {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
            position: relative;
        }
        .rating-item.current::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: #fff;
            border-radius: 0 2px 2px 0;
        }
        .rating-position {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            width: 30px;
            text-align: center;
        }
        .rating-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .rating-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .rating-user-info {
            flex-grow: 1;
        }
        .rating-username {
            font-size: 15px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 2px 0;
        }
        .rating-score {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin: 0;
        }
        .tab-content h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 20px;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }
        .close-button {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 12px;
            background: rgba(18, 18, 23, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1002;
            pointer-events: auto;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .connect-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 16px;
            width: 100%;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .connect-button:active {
            transform: scale(0.98);
            background: #0077b5;
        }
        @media (max-width: 480px) {
            .profile-header {
                padding: 16px;
                gap: 12px;
            }
            .profile-avatar {
                width: 48px;
                height: 48px;
            }
            .profile-name {
                font-size: 18px;
            }
            .profile-bio {
                font-size: 13px;
            }
            .profile-rating {
                padding: 6px 12px;
            }
            .rating-number {
                font-size: 20px;
            }
            .rating-label {
                font-size: 10px;
                margin-top: 2px;
            }
        }
        .wallet-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 24px;
        }
        .wallet-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .wallet-header i {
            font-size: 24px;
            color: #0098EA;
        }
        .wallet-balance {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .balance-amount {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
        }
        .balance-currency {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
        }
        .connect-wallet-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, #0098EA, #0063D1);
            color: #fff;
            border: none;
            border-radius: 16px;
            padding: 16px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 152, 234, 0.2);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .connect-wallet-btn:active {
            transform: scale(0.96) translateY(2px);
            box-shadow: 0 4px 16px rgba(0, 152, 234, 0.15);
        }
        .connect-wallet-btn i {
            font-size: 22px;
        }
        .button-pressed {
            transform: scale(0.96) translateY(2px) !important;
            transition: transform 0.15s ease-in-out !important;
        }
        
        @media (hover: none) {
            .connect-wallet-btn:active {
                transform: scale(0.96) translateY(2px);
            }
        }
        .no-users {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            background: none !important;
            border: none !important;
        }
        
        .no-users-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }
        
        .no-users-message i {
            font-size: 48px;
            opacity: 0.5;
        }
        
        .no-users-message p {
            font-size: 16px;
            margin: 0;
        }
        .task-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }
        .task-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }
        .task-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .task-header i {
            font-size: 24px;
            color: #0098EA;
        }
        .task-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }
        .task-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #0098EA, #0063D1);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .task-button:active {
            transform: scale(0.96);
        }
        .task-button i {
            font-size: 20px;
        }
        .task-button.completed {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: default;
            pointer-events: none;
        }
        .task-button.completed i {
            color: #4CAF50;
        }
        .planet-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }
        .planet-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        .pollution-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .pollution-bar-container {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        .pollution-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
        }
        .pollution-status {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        .planet-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .action-grid {
            display: flex;
            gap: 16px;
        }
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .action-button:active {
            transform: scale(0.96);
        }
        .action-button i {
            font-size: 20px;
        }
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.08); }
            100% { transform: translateX(-50%) scale(1); }
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script async src="https://unpkg.com/es-module-shims/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <div id="loading-screen">
        <div id="loading-container">
            <div id="loading-earth"></div>
            <div id="loading-moon"></div>
        </div>
    </div>
    <div id="scene-container"></div>
    <div class="nav-panel">
        <div class="nav-button" data-section="profile">
            <i class="material-icons">person</i>
        </div>
        <div class="nav-button" data-section="planet">
            <i class="material-icons">public</i>
        </div>
        <div class="nav-button" data-section="tasks">
            <i class="material-icons">assignment</i>
        </div>
        <div class="nav-button" data-section="wallet">
            <i class="material-icons">account_balance_wallet</i>
        </div>
    </div>
    <div class="tab-content">
        <div class="tab-content-inner">
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM полностью загружен - начинаем инициализацию');
            
            // Инициализируем интерфейс одинаково для всех платформ, вне зависимости от Telegram WebApp
            const navPanel = document.querySelector('.nav-panel');
            if (navPanel) {
                navPanel.classList.add('visible');
                console.log('Панель навигации отображена');
            }
            
            // Блокируем стандартные жесты на мобильных устройствах для всех платформ
            document.addEventListener('touchmove', function(e) {
                if (!e.target.closest('.tab-content-inner')) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Общая инициализация для всех платформ
            console.log('Выполняем общую инициализацию');
            updateTokenBalance();
            setupNavigationButtons();
            setupSceneInteraction();
            
            // Настройка обработчиков для кнопок навигации
            function setupNavigationButtons() {
                console.log('Настройка кнопок навигации');
                const navButtons = document.querySelectorAll('.nav-button');
                console.log(`Найдено ${navButtons.length} кнопок навигации`);
                
                if (!navButtons.length) {
                    console.error('Кнопки навигации не найдены!');
                    return;
                }
                
                navButtons.forEach((button, index) => {
                    // Удаляем существующие обработчики перед добавлением новых
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    const section = newButton.getAttribute('data-section');
                    console.log(`Настройка кнопки ${index}: ${section}`);
                    
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const section = this.getAttribute('data-section');
                        if (!section) {
                            console.error('Секция не указана для кнопки');
                            return;
                        }
                        
                        console.log(`[Navigation] Клик по кнопке ${section}`);
                        handleNavClick(section, this);
                    }, { passive: false });
                    
                    // Добавляем также обработчик touchend для лучшей мобильной поддержки
                    newButton.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const section = this.getAttribute('data-section');
                        if (!section) {
                            console.error('Секция не указана для кнопки (touchend)');
                            return;
                        }
                        
                        console.log(`[Navigation] Touchend на кнопке ${section}`);
                        handleNavClick(section, this);
                    }, { passive: false });
                });
            }
            
            // Настройка обработчиков для сцены
            function setupSceneInteraction() {
                console.log('Настройка взаимодействия со сценой');
                const sceneContainer = document.getElementById('scene-container');
                if (sceneContainer) {
                    sceneContainer.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const navPanel = document.querySelector('.nav-panel');
                        if (navPanel && !navPanel.classList.contains('visible')) {
                            navPanel.classList.add('visible');
                            console.log('Панель навигации показана по клику на сцену');
                        }
                    }, { passive: false });
                } else {
                    console.error('Контейнер сцены не найден!');
                }
                
                // Обработка закрытия вкладки
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.close-button')) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Закрытие вкладки по клику на кнопку закрытия');
                        window.closeTab();
                    }
                }, { passive: false });
            }
        });
        
        // Функция для закрытия вкладки
        window.closeTab = function() {
            console.log('Закрытие вкладки');
            const tabContent = document.querySelector('.tab-content');
            const tabInner = document.querySelector('.tab-content-inner');
            const activeButton = document.querySelector('.nav-button.active');
            
            if (activeButton) {
                activeButton.classList.remove('active');
            }
            
            tabContent.classList.add('closing');
            tabContent.style.transform = 'translateY(100%)';
            tabContent.style.borderTopLeftRadius = '0';
            tabContent.style.borderTopRightRadius = '0';
            tabInner.style.opacity = '0';
            
            setTimeout(() => {
                tabContent.classList.remove('active', 'closing');
                tabContent.style.transform = '';
                tabContent.style.borderTopLeftRadius = '';
                tabContent.style.borderTopRightRadius = '';
            }, 300);
        };
    </script>
    <script type="module" src="/js/main.js"></script>
    <script>
    // Функция для обработки навигации
    function handleNavClick(section, clickedButton) {
        console.log(`handleNavClick: открытие вкладки ${section}`);
        
        const buttons = document.querySelectorAll('.nav-button');
        const tabContent = document.querySelector('.tab-content');
        const tabInner = document.querySelector('.tab-content-inner');
        
        if (!tabContent || !tabInner) {
            console.error('Элементы вкладки не найдены!');
            return;
        }
        
        buttons.forEach(btn => btn.classList.remove('active'));
        clickedButton.classList.add('active');
        
        let content = '';
        
        switch(section) {
            case 'wallet':
                console.log('Загрузка содержимого вкладки "Wallet"');
                content = `
                    <h3>Wallet</h3>
                    <button class="close-button" type="button">
                        <i class="material-icons">close</i>
                    </button>
                    <div class="wallet-container">
                        <div class="wallet-header">
                            <i class="material-icons">account_balance_wallet</i>
                            <span>TON Wallet</span>
                        </div>
                        <div class="wallet-content">
                            <p style="margin: 16px 0; font-size: 16px; text-align: center; color: white;">Подключение кошелька будет доступно ближе к аирдропу.</p>
                            <p style="margin: 16px 0; font-size: 16px; text-align: center; color: white;">Следите за новостями!</p>
                        </div>
                    </div>
                `;
                break;
            case 'profile':
                console.log('Загрузка содержимого вкладки "Profile"');
                showProfile();
                break;
            case 'planet':
                console.log('Загрузка содержимого вкладки "Planet"');
                content = `
                    <h3>Планета</h3>
                    <button class="close-button" type="button">
                        <i class="material-icons">close</i>
                    </button>
                    <div class="planet-container" style="display: flex; flex-direction: column; gap: 24px; padding: 0;">
                        <!-- Статус планеты -->
                        <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                <i class="material-icons" style="font-size: 28px; color: #78AAFF; margin-right: 12px;">public</i>
                                <h4 style="margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">Состояние экосистемы</h4>
                            </div>
                            
                            <div class="pollution-info" style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 14px; color: rgba(255, 255, 255, 0.7);">Уровень загрязнения</span>
                                    <span id="pollution-value" style="font-size: 14px; font-weight: 600; font-family: 'Courier New', monospace;"></span>
                                </div>
                                <div style="height: 6px; width: 100%; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; margin-bottom: 8px;">
                                    <div id="pollution-bar" style="height: 100%; width: 50%; transition: width 0.5s ease, background-color 0.5s ease;"></div>
                                </div>
                                <p id="pollution-status" style="margin: 4px 0 0; font-size: 13px; color: rgba(255, 255, 255, 0.6);"></p>
                            </div>
                            
                            <div style="display: flex; align-items: center; background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 12px; margin-top: 8px;">
                                <i class="material-icons" style="font-size: 20px; color: #FFCC00; margin-right: 10px;">info_outline</i>
                                <p style="margin: 0; font-size: 13px; color: rgba(255, 255, 255, 0.8); line-height: 1.4;">Загрязнение автоматически увеличивается на 10% каждый день. Снижайте уровень загрязнения, чтобы получать больше EARTH токенов.</p>
                            </div>
                        </div>
                        
                        <!-- Действия по очистке -->
                        <div style="background: rgba(255, 255, 255, 0.03); border-radius: 20px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <i class="material-icons" style="font-size: 28px; color: #4CAF50; margin-right: 12px;">eco</i>
                                <h4 style="margin: 0; font-size: 18px; font-weight: 500; letter-spacing: -0.01em;">Действия по защите планеты</h4>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button class="action-button" data-reduction="5" data-reward="10" style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.2); padding: 16px; border-radius: 16px; display: flex; align-items: center; transition: all 0.2s ease; text-align: left;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(76, 175, 80, 0.2); display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0;">
                                        <i class="material-icons" style="font-size: 24px; color: #4CAF50;">nature</i>
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">Посадить дерево</div>
                                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">Снижает загрязнение на 5%</div>
                                    </div>
                                    <div style="background: rgba(76, 175, 80, 0.2); color: #4CAF50; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 8px; display: flex; align-items: center;">
                                        <i class="material-icons" style="font-size: 16px; margin-right: 4px;">toll</i>
                                        <span>+10</span>
                                    </div>
                                </button>
                                
                                <button class="action-button" data-reduction="10" data-reward="20" style="background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.2); padding: 16px; border-radius: 16px; display: flex; align-items: center; transition: all 0.2s ease; text-align: left;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(33, 150, 243, 0.2); display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0;">
                                        <i class="material-icons" style="font-size: 24px; color: #2196F3;">waves</i>
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">Очистить океан</div>
                                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">Снижает загрязнение на 10%</div>
                                    </div>
                                    <div style="background: rgba(33, 150, 243, 0.2); color: #2196F3; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 8px; display: flex; align-items: center;">
                                        <i class="material-icons" style="font-size: 16px; margin-right: 4px;">toll</i>
                                        <span>+20</span>
                                    </div>
                                </button>
                                
                                <button class="action-button" data-reduction="7.5" data-reward="15" style="background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.2); padding: 16px; border-radius: 16px; display: flex; align-items: center; transition: all 0.2s ease; text-align: left;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 152, 0, 0.2); display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0;">
                                        <i class="material-icons" style="font-size: 24px; color: #FF9800;">recycling</i>
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 500; font-size: 16px; margin-bottom: 4px;">Переработать отходы</div>
                                        <div style="font-size: 13px; color: rgba(255, 255, 255, 0.6);">Снижает загрязнение на 7.5%</div>
                                    </div>
                                    <div style="background: rgba(255, 152, 0, 0.2); color: #FF9800; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 8px; display: flex; align-items: center;">
                                        <i class="material-icons" style="font-size: 16px; margin-right: 4px;">toll</i>
                                        <span>+15</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                break;
            case 'tasks':
                console.log('Загрузка содержимого вкладки "Tasks"');
                content = `
                    <h3>Available Tasks</h3>
                    <button class="close-button" type="button">
                        <i class="material-icons">close</i>
                    </button>
                    <div class="task-container">
                        <div class="task-item">
                            <div class="task-header">
                                <i class="material-icons">group</i>
                                <span>Join Community</span>
                            </div>
                            <p class="task-description">Join our Earth Community to stay updated!</p>
                            <button class="task-button" id="join-community-btn">
                                <i class="material-icons">telegram</i>
                                Join Community
                            </button>
                        </div>
                    </div>
                `;
                break;
            default:
                console.error(`Неизвестная секция: ${section}`);
                return;
        }
        
        if (section !== 'profile') {
            tabInner.innerHTML = content;
        }
        
        console.log(`Содержимое вкладки ${section} загружено`);
        
        // Update close button handler
        const closeButton = tabInner.querySelector('.close-button');
        if (closeButton) {
            ['touchstart', 'click'].forEach(eventType => {
                closeButton.addEventListener(eventType, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Закрытие вкладки по кнопке');
                    window.closeTab();
                }, { passive: false });
            });
        } else {
            console.warn('Кнопка закрытия не найдена в текущей вкладке');
        }
        
        // Show tab content
        tabContent.classList.add('active');
        setTimeout(() => {
            tabInner.style.opacity = '1';
        }, 50);

        // Установка обработчиков для кнопок в зависимости от вкладки
        if (section === 'tasks') {
            console.log('Настройка кнопок задач');
            const joinButton = document.querySelector('#join-community-btn');
            if (joinButton) {
                ['touchstart', 'click'].forEach(eventType => {
                    joinButton.addEventListener(eventType, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Открытие ссылки сообщества');
                        window.location.href = 'https://t.me/NotEarthCommunity';
                    }, { passive: false });
                });
            } else {
                console.warn('Кнопка подключения к сообществу не найдена');
            }
        } else if (section === 'planet') {
            console.log('Настройка действий для вкладки Планета');
            // Задержка для уверенности, что DOM полностью обновлен
            setTimeout(() => {
                setupPlanetActions();
            }, 50);
        }
        
        console.log(`Вкладка ${section} полностью настроена`);
    }

    // Функция для обновления отображения баланса токенов
    function updateTokenBalance() {
        console.log('Обновление отображения баланса токенов');
        
        // Получаем текущий баланс токенов
        let tokens = localStorage.getItem('earthTokens');
        tokens = tokens ? parseInt(tokens) : 0;
        
        console.log(`Текущий баланс токенов: ${tokens}`);
        
        // Проверяем, существует ли уже элемент баланса
        let tokenBalanceEl = document.getElementById('token-balance');
        
        // Если элемент не существует, создаем его
        if (!tokenBalanceEl) {
            console.log('Создаем элемент баланса токенов');
            tokenBalanceEl = document.createElement('div');
            tokenBalanceEl.id = 'token-balance';
            tokenBalanceEl.style.cssText = `
                position: fixed;
                top: 60px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, rgba(18, 18, 23, 0.9), rgba(34, 34, 42, 0.9));
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 16px;
                padding: 10px 18px;
                color: #FFFFFF;
                font-family: 'Courier New', monospace;
                font-weight: bold;
                font-size: 18px;
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                z-index: 997;
                display: flex;
                align-items: center;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(255, 255, 255, 0.1);
            `;
            document.body.appendChild(tokenBalanceEl);
        }
        
        // Обновляем содержимое с белым цветом
        tokenBalanceEl.innerHTML = `
            <i class="material-icons" style="margin-right: 10px; font-size: 20px; color: #FFFFFF; text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);">toll</i>
            <span style="letter-spacing: 1.2px;">${tokens} EARTH</span>
        `;
        
        console.log('Отображение баланса токенов обновлено');
    }
    
    // Функция добавления обработчиков к кнопкам действий планеты
    function setupPlanetActions() {
        console.log('Настройка действий планеты');
        
        // Получаем текущий уровень загрязнения
        let pollution = localStorage.getItem('earthPollution');
        pollution = pollution ? parseFloat(pollution) : 50;
        
        console.log(`Текущий уровень загрязнения: ${pollution}%`);
        
        // Проверяем, был ли обновлен в текущий день
        const lastUpdate = localStorage.getItem('pollutionLastUpdate');
        const currentDate = new Date().toDateString();
        
        // Если новый день, увеличиваем загрязнение на 10%
        if (lastUpdate !== currentDate) {
            console.log('Новый день, увеличиваем загрязнение на 10%');
            pollution = Math.min(100, pollution + 10);
            localStorage.setItem('earthPollution', pollution.toString());
            localStorage.setItem('pollutionLastUpdate', currentDate);
        }
        
        // Обновляем отображение уровня загрязнения
        const pollutionBar = document.getElementById('pollution-bar');
        const pollutionValue = document.getElementById('pollution-value');
        const pollutionStatus = document.getElementById('pollution-status');
        
        if (pollutionBar && pollutionValue && pollutionStatus) {
            console.log('Обновляем индикаторы загрязнения');
            
            // Устанавливаем ширину полосы
            pollutionBar.style.width = `${pollution}%`;
            pollutionValue.textContent = `${pollution.toFixed(1)}%`;
            
            // Устанавливаем цвет и текст статуса в зависимости от уровня загрязнения
            if (pollution < 20) {
                pollutionBar.style.background = '#4CAF50'; // зеленый
                pollutionStatus.textContent = 'Отличное состояние, экосистема здорова';
                pollutionStatus.style.color = '#4CAF50';
            } else if (pollution < 50) {
                pollutionBar.style.background = '#FFC107'; // желтый
                pollutionStatus.textContent = 'Умеренное загрязнение, нужны действия по очистке';
                pollutionStatus.style.color = '#FFC107';
            } else if (pollution < 80) {
                pollutionBar.style.background = '#FF9800'; // оранжевый
                pollutionStatus.textContent = 'Высокое загрязнение, требуются срочные меры';
                pollutionStatus.style.color = '#FF9800';
            } else {
                pollutionBar.style.background = '#F44336'; // красный
                pollutionStatus.textContent = 'Критический уровень, планета в опасности!';
                pollutionStatus.style.color = '#F44336';
            }
        } else {
            console.error('Элементы индикаторов загрязнения не найдены!');
        }
        
        // Обрабатываем нажатие на кнопки очистки
        const actionButtons = document.querySelectorAll('.action-button');
        console.log(`Найдено ${actionButtons.length} кнопок действий`);
        
        if (!actionButtons.length) {
            console.error('Кнопки действий не найдены!');
            return;
        }
        
        actionButtons.forEach((button, index) => {
            console.log(`Настройка кнопки действия ${index}`);
            
            // Удаляем предыдущие обработчики, чтобы избежать дублирования
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', function() {
                const reduction = parseFloat(this.getAttribute('data-reduction'));
                const reward = parseInt(this.getAttribute('data-reward'));
                
                console.log(`Действие: снижение загрязнения на ${reduction}%, награда ${reward} токенов`);
                
                // Получаем текущий уровень загрязнения
                let pollution = localStorage.getItem('earthPollution');
                pollution = pollution ? parseFloat(pollution) : 50;
                
                // Получаем текущий баланс токенов
                let tokens = localStorage.getItem('earthTokens');
                tokens = tokens ? parseInt(tokens) : 0;
                
                // Снижаем загрязнение и начисляем токены
                pollution = Math.max(0, pollution - reduction);
                tokens += reward;
                
                console.log(`Новый уровень загрязнения: ${pollution}%, новый баланс: ${tokens} токенов`);
                
                // Сохраняем новые значения
                localStorage.setItem('earthPollution', pollution.toString());
                localStorage.setItem('earthTokens', tokens.toString());
                
                // Обновляем отображение баланса токенов
                updateTokenBalance();
                
                // Создаем эффект пульсации токена при начислении
                const tokenBalanceEl = document.getElementById('token-balance');
                if (tokenBalanceEl) {
                    tokenBalanceEl.style.animation = 'pulse 0.5s ease';
                    setTimeout(() => {
                        tokenBalanceEl.style.animation = '';
                    }, 500);
                }
                
                // Временно показываем сообщение об успехе
                const originalContent = this.innerHTML;
                const originalBackground = this.style.background;
                
                this.style.background = 'rgba(76, 175, 80, 0.2)';
                this.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; width: 100%;">
                        <i class="material-icons" style="color: #4CAF50; margin-right: 8px;">check_circle</i>
                        <span style="color: #4CAF50; font-weight: 500;">Успешно!</span>
                    </div>
                `;
                
                // Обновляем отображение полосы загрязнения
                if (pollutionBar && pollutionValue && pollutionStatus) {
                    // Плавно меняем ширину полосы
                    pollutionBar.style.transition = 'width 0.5s ease, background-color 0.5s ease';
                    pollutionBar.style.width = `${pollution}%`;
                    pollutionValue.textContent = `${pollution.toFixed(1)}%`;
                    
                    // Обновляем цвет и текст статуса
                    if (pollution < 20) {
                        pollutionBar.style.background = '#4CAF50'; // зеленый
                        pollutionStatus.textContent = 'Отличное состояние, экосистема здорова';
                        pollutionStatus.style.color = '#4CAF50';
                    } else if (pollution < 50) {
                        pollutionBar.style.background = '#FFC107'; // желтый
                        pollutionStatus.textContent = 'Умеренное загрязнение, нужны действия по очистке';
                        pollutionStatus.style.color = '#FFC107';
                    } else if (pollution < 80) {
                        pollutionBar.style.background = '#FF9800'; // оранжевый
                        pollutionStatus.textContent = 'Высокое загрязнение, требуются срочные меры';
                        pollutionStatus.style.color = '#FF9800';
                    } else {
                        pollutionBar.style.background = '#F44336'; // красный
                        pollutionStatus.textContent = 'Критический уровень, планета в опасности!';
                        pollutionStatus.style.color = '#F44336';
                    }
                }
                
                // Блокируем кнопку на время
                this.disabled = true;
                
                // Через 2 секунды восстанавливаем кнопку
                setTimeout(() => {
                    this.disabled = false;
                    this.innerHTML = originalContent;
                    this.style.background = originalBackground;
                }, 2000);
            });
            
            // Добавляем также обработчик touchend для лучшей мобильной поддержки
            newButton.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.click(); // Имитируем клик
            }, { passive: false });
        });
    }
    
    // Функция для проверки и обновления загрязнения планеты
    function updatePlanetPollution() {
        // Получаем текущий уровень загрязнения
        let pollution = localStorage.getItem('earthPollution');
        let lastUpdated = localStorage.getItem('pollutionLastUpdate');
        
        const currentDate = new Date().toDateString();
        
        // Если загрязнение не инициализировано, устанавливаем значение по умолчанию
        if (!pollution) {
            pollution = 50; // начальное значение 50%
            localStorage.setItem('earthPollution', pollution);
            localStorage.setItem('pollutionLastUpdate', currentDate);
        } else {
            pollution = parseFloat(pollution);
            
            // Если с последнего обновления прошел хотя бы день
            if (lastUpdated !== currentDate) {
                // Увеличиваем загрязнение на 10%
                pollution = Math.min(100, pollution + 10);
                localStorage.setItem('earthPollution', pollution.toString());
                localStorage.setItem('pollutionLastUpdate', currentDate);
            }
        }
        
        return pollution;
    }

    // Показываем панель навигации при первом касании экрана
    let isFirstTouch = true;
    
    document.addEventListener('touchstart', function(e) {
        if (isFirstTouch) {
            console.log('Первое касание, показываем панель навигации');
            const navPanel = document.querySelector('.nav-panel');
            if (navPanel) {
                navPanel.classList.add('visible');
            }
            isFirstTouch = false;
        }
    }, { passive: true });
    
    // Инициализируем баланс токенов, если он не установлен
    if (!localStorage.getItem('earthTokens')) {
        console.log('Инициализация начального баланса токенов');
        localStorage.setItem('earthTokens', '100');
    }
    
    // Инициализируем уровень загрязнения, если он не установлен
    if (!localStorage.getItem('earthPollution')) {
        console.log('Инициализация начального уровня загрязнения');
        localStorage.setItem('earthPollution', '50');
        localStorage.setItem('pollutionLastUpdate', new Date().toDateString());
    }
    </script>
    <script>
    // Функция показа профиля
    function showProfile() {
        const tabInner = document.querySelector('.tab-content-inner');
        // Используем локальное изображение вместо внешнего placeholder
        const defaultAvatar = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><rect width="80" height="80" fill="%23666"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="35" fill="%23fff">P</text></svg>';
        
        tabInner.innerHTML = `
            <h3>Profile</h3>
            <button class="close-button" type="button" onclick="window.closeTab()">
                <i class="material-icons">close</i>
            </button>
            <div class="profile-header">
                <div class="profile-avatar">
                    <img src="${defaultAvatar}" alt="Profile Avatar">
                </div>
                <div class="profile-info">
                    <h4 class="profile-name">Пользователь Earth 3D</h4>
                    <p class="profile-bio">Подробная информация профиля будет доступна позже</p>
                </div>
                <div class="profile-rating">
                    <p class="rating-number">#-</p>
                    <p class="rating-label">Rating</p>
                </div>
            </div>
        `;
    }
    </script>
</body>
</html>